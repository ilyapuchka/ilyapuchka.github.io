{"componentChunkName":"component---src-templates-blog-post-js","path":"/url-parser-in-swift-functional-style-part-1/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"d03061a7-a4cd-5362-b15e-7f66ad3e1698","excerpt":"When I published one of my previous posts about deeplinks and then decided to turn it into a framework it turned out that Brandon Williams was working on aâ€¦","html":"<p>When I published one of my previous <a href=\"http://ilya.puchka.me/deeplinks-no-brainer/\">posts about deeplinks</a> and then decided to turn it into a <a href=\"https://github.com/ilyapuchka/Deeper\">framework</a> it turned out that <a href=\"https://twitter.com/mbrandonw\">Brandon Williams</a> was working on a similar thing for his <a href=\"https://github.com/pointfreeco/swift-web/pull/61/files\">Point-Free project</a>, but related to parsing http requests for web framework. As parsing URLs is a subset of this problem I decided to go through his implementation and apply the same technique to rewrite parser that I have written in imperative way (and probably not in the best way) in a functional style. Just to see where it goes and as exercise in a functional programming. So here is the path I went through.</p>\n<h4>Problem</h4>\n<p>Let's first describe a problem. We want to write a URL parser that will give us a type-safe way to define deeplink \"routes\" in our app (in my previous post I call them \"intents\", but I will be using \"routes\" here). There are few design goals for that:</p>\n<ul>\n<li>each route should be defined by enum case that should correspond to some \"route pattern\". For example we can have our routes defined like this:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">Routes</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> showMyProfile\n    <span class=\"token keyword\">case</span> <span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">follow</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">retweet</span><span class=\"token punctuation\">(</span>tweetId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">showUserTweet</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> tweetId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>route can have typed parameters extracted from path components or from query. For routes defined above we can imaging following patterns:</li>\n</ul>\n<p><code>/users/me</code><br/>\n<code>/users/:string/profile</code><br/>\n<code>/users/:string/follow</code><br/>\n<code>/retweet?tweetId=:int</code><br/>\n<code>/users/:string/tweets/:int</code><br/></p>\n<p>Here <code>:string</code> or <code>:int</code> stands for parameter of <code>String</code> or <code>Int</code> type. As you can see they can be defined as part of the path or query. When several parameters are defined they should strictly match types and order of associated values in the route case. This way complier will only allow us to associate routes with patterns when their parameter types match.</p>\n<ul>\n<li>\n<p>route can have special patterns like <code>*</code> for matching any path components in the start/end/middle of the path, <code>()</code> for optional parameters, conditional pattern <code>this|that</code> that matches either left or right option</p>\n</li>\n<li>\n<p>it should be possible to \"print\" url for specific route based on the pattern it was previously associated with. This way we can not only handle deeplinks but build our entire app navigation based on URLs and perform navigation witch a call to <code>open(url:)</code>:</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> route <span class=\"token operator\">=</span> <span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span><span class=\"token function\">showUserTweet</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"username\"</span></span><span class=\"token punctuation\">,</span> tweetId<span class=\"token punctuation\">:</span> <span class=\"token number\">123</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> route<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// url = \"appscheme://users/username/tweets/123\"</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> url<span class=\"token punctuation\">)</span></code></pre></div>\n<h4>The ground</h4>\n<p>To start up we need to define our basic building blocks. This part I find one of the most difficult in functional programming. The basic units are so small but mean so much for a final result that it is very important, but sometimes difficult, to find a proper abstraction. Our abstractions will be the following:</p>\n<ul>\n<li>url (or route) components, consisting of array of paths and dictionary of query items.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">typealias</span> <span class=\"token class-name\">RouteComponents</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>parser, which is a function that takes in route components and returns the rest of them that it didn't process, along with matched value that it extracted from processed components. If parsing fails it should return <code>nil</code>.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">typealias</span> <span class=\"token class-name\">Parser</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RouteComponents</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span>rest<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RouteComponents</span><span class=\"token punctuation\">,</span> match<span class=\"token punctuation\">:</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span></code></pre></div>\n<ul>\n<li>printer, that based on the input for parameter value returns route components where parameter placeholder (<code>/:string</code> or <code>?key=:string</code>) is replaced with its value (<code>/abc</code> or <code>?key=abc</code>). If printing fails it should return <code>nil</code>.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">typealias</span> <span class=\"token class-name\">Printer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RouteComponents</span><span class=\"token operator\">?</span></code></pre></div>\n<ul>\n<li>route pattern, which contains of parser, printer and a template string:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">PatternState</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> parse<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Parser</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> print<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Printer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> template<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It has two generic parameters, <code>A</code> for type of parameter and <code>S</code> for state of pattern. This state we will model based on phantom types which we will use to define operations only possible on patterns in specific states.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">protocol</span> <span class=\"token class-name\">PatternState</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">protocol</span> <span class=\"token class-name\">ClosedPatternState</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">PatternState</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">// pattern is complete</span>\n<span class=\"token keyword\">protocol</span> <span class=\"token class-name\">OpenPatternState</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">PatternState</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">// pattern requires subsequent pattern to become closed</span>\n\n<span class=\"token keyword\">protocol</span> <span class=\"token class-name\">ClosedPathPatternState</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPatternState</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">Path</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPathPatternState</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">// pattern only has path components</span>\n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">Query</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPatternState</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">// pattern has path and query components</span></code></pre></div>\n<p>Here you can see that we not only define that pattern can be in <code>Path</code> or <code>Query</code> state, but also it can be <code>closed</code> or <code>opened</code>. Later we will use <code>opened</code> state to implement <code>*</code> pattern that is used in the start or middle of the pattern.</p>\n<h4>Path patterns</h4>\n<p>With these abstractions we can start building our patterns! There can be two types of path patterns:</p>\n<ul>\n<li>string path component (or \"literal\"), i.e. <code>/users</code></li>\n<li>path parameter, i.e. <code>:string</code></li>\n</ul>\n<p>Let's start with a simplest literal pattern.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> str<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> route <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> route<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>first <span class=\"token operator\">==</span> str <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token omit keyword\">_</span> <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>str<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> str<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To parse this pattern we should check if the first path component matches the literal and if it does we should return the rest of components, otherwise we should fail parsing by returning <code>nil</code>. No parameter value will be captured, so pattern parameter type will be <code>Void</code>. Literals can be only used in path, so the state of the pattern will be <code>Path</code>. To print the url we should just put a literal value in a path components. And the template for this pattern is just a literal itself.</p>\n<p>With this we can already define pattern that will consist of single path component:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> login <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"login\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://login\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> login<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), ())</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> login<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"login\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> myProfile<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \"login\"</span></code></pre></div>\n<p>Pretty cool and simple, but not very useful. So let's move on to path parameter pattern.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">pathParam</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> apply<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">A</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> unapply<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> route <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> pathComponent <span class=\"token operator\">=</span> route<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>pathComponent<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> parsed<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> a <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> string <span class=\"token operator\">=</span> <span class=\"token function\">unapply</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>string<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">pathParamTemplate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">pathParamTemplate</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> type<span class=\"token punctuation\">:</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\":</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">typeKey</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This one is a bit more complicated. For that pattern to be parsed a path component, which is of <code>String</code> type, should be successfully transformed to type <code>A</code>, which can be <code>Int</code>, <code>Double</code> or <code>String</code>. For that transformation we pass in <code>apply</code> function. If this transformation fails or there is no path components left we fail parsing, otherwise we drop first path component and return parsed value for matched result. For printing we need to do a backward transformation, from value of type <code>A</code> to <code>String</code>. For that we use <code>unapply</code> function. For template string we use a simple helper that converts type to it's string representation, i.e. <code>String</code> to <code>:string</code>, <code>Int</code> to <code>:int</code>.</p>\n<p>To simplify working with path parameters we will introduce helper functions for each type of parameter which will build up in a small DSL:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> string <span class=\"token operator\">=</span> <span class=\"token function\">pathParam</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> int <span class=\"token operator\">=</span> <span class=\"token function\">pathParam</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> double <span class=\"token operator\">=</span> <span class=\"token function\">pathParam</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Here we provide constructors from standard library to perform transformations between type of parameter and <code>String</code>. With that we can define a simple route with a single path parameter.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://123\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> int<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), 123)</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> int<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token number\">123</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"123\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> int<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \":int\"</span></code></pre></div>\n<p>Again cool and simple, but still not very useful.</p>\n<h4>Patterns composition</h4>\n<p>To make this really useful and before we continue with query patterns we need to define a way to combine different patterns so that we can build bigger patterns.</p>\n<p>For that we will use function composition. Route patterns essentially are just boxes of pure parser and printer functions, so they can be easily composed together. Let's look at how we can compose parsers.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">parseBoth</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Parser</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> route <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> lhsResult <span class=\"token operator\">=</span> lhs<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> rhsResult <span class=\"token operator\">=</span> rhs<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>lhsResult<span class=\"token punctuation\">.</span>rest<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>rhsResult<span class=\"token punctuation\">.</span>rest<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>lhsResult<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">,</span> rhsResult<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we define a function that accepts two route patterns of any parameter type (and of any state) and returns a new parser that parses both of those patterns' values in a tuple. For that we first parse route components using left pattern, then if it succeeds we get the rest of path components and parse them with a right pattern. If it also succeeds we return the rest of path components and match result of both left and right patterns.</p>\n<p>Printer composition is done pretty much the same way:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">printBoth</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Printer</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> lhs <span class=\"token operator\">=</span> lhs<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> rhs<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">.</span>path <span class=\"token operator\">+</span> rhs<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span> lhs<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span><span class=\"token function\">merging</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">,</span> uniquingKeysWith<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We again get two patterns and first use left pattern to print route components using left tuple value, then we use right pattern to print route components using right tuple value. If both succeed we merge the results.</p>\n<p>Template composition is a bit different, as template is not a function but just a <code>String</code>, but it is even simpler:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">templateAnd</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">lhs<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">/</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">rhs<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We just get templates of both patterns and concatenate them with <code>/</code>. Another difference here is that this function can only be applied to patterns in <code>Path</code> state, because of different separators for path components (<code>/</code>) and for query components (<code>?</code> or <code>&#x26;</code>). This is one of examples of phantom types usage.</p>\n<p>With all that we now can define a function that will \"concatenate\" two patterns. For that we will introduce a custom operator, so that writing it will feel more natural.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">infix</span> <span class=\"token keyword\">operator</span> <span class=\"token operator\">>/></span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">MultiplicationPrecedence</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Path</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">>/>&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Again we use phantom type here to constrain this operation to patterns only in <code>Path</code> state. Implementation is trivial, we use functions that we defined before to compose parsers, printers and templates and construct a new pattern with them. What we get with this is pretty cool though. Now we can combine two patterns into one which will internally parse or print both of them and will only succeed in parsing or printing of both of them succeed. We already can build patterns for 4 of 5 routes that we defined in the beginning.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> profileRoute <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>/></span> string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"profile\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://users/username/profile\"</span></span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> int<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), (((), \"username\"), ()))</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> int<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">\"username\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"username\", \"profile\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> int<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \"users/:string/profile\"</span></code></pre></div>\n<p>Pretty cool! Though you can spot a nasty issue here. Every time when we compose two patterns with parameter types <code>A</code> and <code>B</code> we will end up with a new pattern with parameter type <code>(A, B)</code>. If we now compose it with another pattern with parameter type <code>C</code> we will get pattern with type <code>((A, B), C)</code>. And so on. So parsing in this example will give us a value of <code>((Void, String), Void)</code>. But then we need to use this value somehow to create a case of route, as this should be the result of our \"pattern matching\". For this example it is <code>showProfile(userId: String)</code>. You can see that type of pattern parameter and type of route associated values do not match. We can of course redefine our route as <code>showProfile(((Void, String), Void))</code> but this is just ugly and unusable. How we can solve that?</p>\n<p>With another custom operator! Well, to be fair, operators here are just helpers to provide more natural way of composing patterns, the solution for the problem is again in function composition.</p>\n<p>When parsing literal patterns we are not very interested in <code>Void</code> matching result. It is just placeholder for generic type parameter. So let's drop it! To do that we need to handle three cases: when we have <code>Void</code> type on the left, on the right and on both sides. Here is our parsers composition for these cases:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">parseLeft</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Parser</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> route <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>rest<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">parseRight</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Parser</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> route <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>rest<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">.</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>parseLeft</code> function parses both left and right parser, but only returns matched value of left pattern. <code>parseRight</code> does the same but returns matched value of right pattern. In case we have patterns with <code>Void</code> parameter type on both sides we can use either of these functions because it does not matter if we return <code>Void</code> from left or right pattern.</p>\n<p>Printers composition will be a bit different:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">printLeft</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Printer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">printRight</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LS</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">RS</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Printer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Again we pass in left and right pattern, but we want a printer that will print both of them, but will only need left or right value as input. As we need values for both patterns to pass to <code>printBoth</code> printer we just create <code>Void</code> value inline.</p>\n<p>We don't need to change anything in templates composition as it works already who we need it to work, so let's now define pattern composition:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">infix</span> <span class=\"token keyword\">operator</span> <span class=\"token operator\">/></span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">MultiplicationPrecedence</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Path</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">>/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseLeft</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printLeft</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We introduce new operator <code>/></code> that will be used to drop left side parameter value and will be only applicable when left pattern has <code>Void</code> parameter type. It will return pattern with only right parameter type, we achieve that by using <code>parseRight</code> and <code>printRight</code> functions.</p>\n<p>For the case when pattern with <code>Void</code> parameter type is on the right side we reuse <code>>/></code> operator, using <code>parseLeft</code> and <code>printLeft</code> functions.</p>\n<blockquote>\n<p>Note: I decided to reuse <code>>/></code> operator here for two reasons. One is that it's better if you make user to use less custom operators. Second is that it should be easy to remember that left <code>></code> in this operator means that left parameter type will be preserved in contrast to <code>/></code> operator. I could define <code>>/</code> operator but it will make users think about what operator to use where. With <code>/></code> and <code>>/></code> you end up with <code>/></code> only used before you introduce parameter pattern, after it you'll always use <code>>/></code>. I also can't use just <code>>/></code> or <code>/></code> always as I will have too many overloads of it, which will make expressions to complex for Swift compiler.</p>\n</blockquote>\n<p>Let's now see what we can do with that.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> profileRoute <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"profile\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://users/username/profile\"</span></span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> profileRoute<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), \"username\")</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> profileRoute<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"username\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"username\", \"profile\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> profileRoute<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \"users/:string/profile\"</span></code></pre></div>\n<p>Now our <code>profileRoute</code> will have type <code>RoutePattern&#x3C;String, Path></code> and we will only get single matched value from parse and need to provide only single value to print function. The same applies when we have only literal patterns:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> myProfile <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"me\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://users/me\"</span></span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> myProfile<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), ())</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> myProfile<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"me\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> myProfile<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \"users/me\"</span></code></pre></div>\n<p>Here pattern type will be <code>RoutePattern&#x3C;Void, Path></code> instead of <code>RoutePattern&#x3C;(Void, Void), Path></code> if we would use <code>>/></code> operator.</p>\n<h4>Query patterns</h4>\n<p>Now lets move on to query patterns. In queries we can only have parameter patterns, but the difference is that they are named and come in as a dictionary with their names as keys.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">queryParam</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> apply<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">A</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> unapply<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> route <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> queryValue <span class=\"token operator\">=</span> route<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>queryValue<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">,</span> parsed<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> a <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> value <span class=\"token operator\">=</span> <span class=\"token function\">unapply</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">:</span> value<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">queryParamTemplate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">queryParamTemplate</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> type<span class=\"token punctuation\">:</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">key</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">=:</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">typeKey</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is pretty much the same as parsing path parameters except that we are passing in the key for parameter name. We also don't necessary have to drop query components when they are parsed as we should allow any other query components in the url besides those defined in pattern. Another difference is that result of this function is a pattern in a <code>Query</code> state.</p>\n<p>To make it easier to use this function we can define few helper methods for each of query parameter types, similar to what we did for path pattern:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">int</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">queryParam</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">double</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Double</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">queryParam</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">bool</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Bool</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">queryParam</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">.</span>fromString<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">.</span>toString<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">string</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">queryParam</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we can define pattern composition:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">infix</span> <span class=\"token keyword\">operator</span> <span class=\"token operator\">.?</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">MultiplicationPrecedence</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Query</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">.?</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">.?&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">&amp;&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">templateAnd</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPathPatternState</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">lhs<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">?</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">rhs<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">templateAnd</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">lhs<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">&amp;</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">rhs<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Similarly to what we did to drop <code>Void</code> parameter type in path patterns we define a function that will drop <code>Void</code> parameter of the left path pattern and will only return value of right query pattern. We also define two new variants of <code>templateAnd</code> function that uses proper separators between path and query.</p>\n<p>Now we can build patterns not only with path components but also with query:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> retweetRoute <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"retweet) .? int(\"</span></span>tweetId\"<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://retweet?tweetId=123\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> retweetRoute<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), 123)</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> retweetRoute<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token number\">123</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"retweet\"], query: [\"tweetId\": 123])</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> retweetRoute<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \"retweet?tweetId=:int\"</span></code></pre></div>\n<h4>Conclusion</h4>\n<p>I think this should be enough for the first part. We already achieved a lot. We can construct simple and more complicated patterns made of few smaller patterns, both with path and query parameters, and we solved the issue with unneeded <code>Void</code> types.</p>\n<p>If that's not too much code for you already, see you in the <a href=\"http://ilya.puchka.me/url-parser-in-functional-style-part-2/\">second part</a>.<br>\nYou can find all the code on <a href=\"https://github.com/ilyapuchka/Deeper/pull/5\">github</a>.</p>","fields":{"slug":"/url-parser-in-swift-functional-style-part-1/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f86","title":"URL parser in functional style. Part 1.","date":"November 07, 2017","description":"When I published one of my previous posts about deeplinks and then decided to turn it into a framework it turned out that Brandon Williams was working on a similar thing for his Point-Free project, but related to parsing http requests for web framework. As parsing URLs is a subset of this problem I decided to go through his implementation and apply the same technique to rewrite parser that I have written in imperative way (and probably not in the best way) in a functional style. Just to see where it goes and as exercise in a functional programming. So here is the path I went through.","tags":""}},"previous":{"excerpt":"This is a short story of a regression in Swift 4 that I've recently had to deal with. It can seem as a simple problem, but I think it's a good example ofâ€¦","fields":{"slug":"/swift-4-tricky-filters/"},"frontmatter":{"title":"Swift 4 tricky filters","date":"September 26, 2017"}},"next":{"excerpt":"In previous part we started to write base components of URL parser. Time to extend it and add some additional functionality, like conditional, optional andâ€¦","fields":{"slug":"/url-parser-in-functional-style-part-2/"},"frontmatter":{"title":"URL parser in functional style. Part 2.","date":"November 07, 2017"}}},"pageContext":{"id":"d03061a7-a4cd-5362-b15e-7f66ad3e1698","previousPostId":"be3abaac-6946-526e-b286-ac3176707924","nextPostId":"d1a09427-7e5b-55a4-a1da-506f7e136ef6"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}