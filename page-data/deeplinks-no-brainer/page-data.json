{"componentChunkName":"component---src-templates-blog-post-js","path":"/deeplinks-no-brainer/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"5622e826-03a2-52ff-9ece-efd84781794f","excerpt":"Very often in my practice deep links were something that no one cares much, they work somehow and its fine. Or there are just few of them and its really notâ€¦","html":"<p>Very often in my practice deep links were something that no one cares much, they work somehow and its fine. Or there are just few of them and its really not hard to maintain. But working for a long time on one product that targets several very different markets reveals all the importance of deep links in a long run. There are always requests from marketing teams to support new kind of deep link for a new marketing campaign, to open some new screen in the app from push notification, or with some specific parameters, when existing deep link can't be reused for what ever reason and you have to create yet another one for the same action. In the modern app there are also all kinds of different sources of urls that should act like a deep link to your app - universal links, push notifications, shortcut items etc.</p>\n<!-- description -->\n<p>Unless your app's navigation is architectured entirely around URLs, when you basically get deep links handling for free, it can very fast become a nightmare to maintain. Bad deep links implementations can suffer from different severe issues, sometimes few of them at the same time:</p>\n<ul>\n<li>it is usually heavily stringly typed</li>\n<li>warm and cold state handling is fragile and unpredictable, sometimes everything works, sometime - fails miserably</li>\n<li>its hard to debug, requires to step through each line of code</li>\n<li>impossible to see what deep links are handled on the screen just by glancing at code</li>\n<li>no tracking, no error reporting, no logging</li>\n<li>no tests</li>\n<li>something breaks almost with each release and is discovered much later</li>\n</ul>\n<p>In this post I'll describe an approach for deep links handling that I've just recently came up with trying to address all aforementioned issues. The main design goals of this approach are:</p>\n<ul>\n<li>reliability, deep links should not break, or at least should break less</li>\n<li>readability, it should be clear how deep links are handeled</li>\n<li>testability, it should be easier to unit test deep links</li>\n<li>tracking, it should be easier to track deep link handling, both during debuggin and in production</li>\n</ul>\n<p>Probably most obvious solution would be just to present final screens modally from what ever place in the app, or to push it on top of the current navigation stack. If that would be the case there wouldn't be this post in the first place. You still would need to handle different states of view hierarchy but things will become much easier comparing to the case when opening deep link should involve navigation to intermediate screens, like if user would navigate to them themselves. So keep in mind that it's the case.</p>\n<p>Solution involves several action points. First, deep links should be described in a type safe manner, avoiding stringly typing as much as possible. This can be achieved by using enums or structs. Next, state of deep link handling should be stored in memory and this information should be descriptive. Again enums come for the rescue. It should be possible to track this state for error and successful scenarious. Deep links routes registration should be clear from side effects, like opening modal screens or switching tabs, to make it easier to unit test. Finally handling deep links from a cold and warm start should be done in a predictable way by always starting it from a single point and then sinking deep link through the application's screens graph.</p>\n<h3>Strongly typed deep links</h3>\n<p>Each deep link is represented with an url and an <em>intent</em> that is modelled by enum with associated values. You should aim to have as little deep links variations as possible and having too many cases in the enum will help you to assert that. This intent cases describe actions which should be performed as a result of deep link handling, usually opening some screen in the app.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">DeepLink</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> url<span class=\"token punctuation\">:</span> <span class=\"token constant\">URL</span>\n    <span class=\"token keyword\">let</span> intent<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Intent</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Intent</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token function\">showRecipe</span><span class=\"token punctuation\">(</span>recipeId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> weekOrMenuId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Either</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token function\">showSubscription</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> week<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">add</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"subscription/:subscriptionId/swap/:menuId\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"subscription/:subscriptionId/:weekId/edit\"</span></span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Intent</span><span class=\"token operator\">?</span> <span class=\"token keyword\">in</span>\n        <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Alternatively deep link can be described with a protocol and multiple structs (or classes if you want) implementing this protocol. When handeled, instead of switching over intent we will switch over type of deep link, which is basically the same.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">protocol</span> <span class=\"token class-name\">DeepLink</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> url<span class=\"token punctuation\">:</span> <span class=\"token constant\">URL</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> authorized<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">init</span><span class=\"token operator\">?</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> <span class=\"token constant\">URL</span><span class=\"token punctuation\">,</span> dictionary<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">MealSwapDeepLink</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string-literal\"><span class=\"token string\">\"subscription/:subscriptionId/swap/:menuId\"</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-literal\"><span class=\"token string\">\"subscription/:subscriptionId/:weekId/edit\"</span></span>\n    <span class=\"token punctuation\">]</span>\n    \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> requiresAuthorization <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n    <span class=\"token keyword\">let</span> url<span class=\"token punctuation\">:</span> <span class=\"token constant\">URL</span>\n    <span class=\"token keyword\">let</span> subscriptionId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> menuOrWeekId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Either</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token operator\">></span>\n    \n    <span class=\"token keyword\">init</span><span class=\"token operator\">?</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> <span class=\"token constant\">URL</span><span class=\"token punctuation\">,</span> dictionary<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Using protocol approach can give more flexibility (Swift enums are relatively rigid and limited), isolate unrelated deep links from each other in separate files, what can be considered as a drawback though. But it also comes with drawbacks like possible types explosion and more boilerplate to write.<br>\nEnum approach on the other hand looks cleaner and requires less boilerplate. Also if you already use libraries like <a href=\"https://github.com/joeldev/JLRoutes\">JLRoutes</a> it will require less changes to the code structure.<br>\nThey both suffer from violation of Open-Closed Principle, but it feels like trying to solve this will unnecessary complicate the implementation.</p>\n<p>The rest of code examples will be based on enums approach.</p>\n<h3>State of deep link handling</h3>\n<p>Deep link handling state can be also represented as enum. Having a custom type for that will give you more control over it.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">DeepLinkHandling</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">CustomStringConvertible</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// deeplink successfully handled</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">opened</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// deeplink was rejected because it can't be handeled, with optional log message</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// deeplink handling delayed because more data is needed</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// deeplink was passed through to some other handler</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">passedThrough</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandler</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">var</span> description<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">opened</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> deeplink<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"Opened deeplink </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">deeplink</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> deeplink<span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"Rejected deeplink </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">deeplink</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\"> for reason : </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">reason <span class=\"token operator\">??</span> <span class=\"token string-literal\"><span class=\"token string\">\"unknown\"</span></span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> deeplink<span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"Delayed deeplink </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">deeplink</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">passedThrough</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> handler<span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> deeplink<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"Passed through deeplink </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">deeplink</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\"> to </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">type</span><span class=\"token punctuation\">(</span>of<span class=\"token punctuation\">:</span> handler<span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With such type you can describe each state of deep link handling that you can be interested in (you might need some more cases depending on the architecture of your app, but you got the idea), and will be able to associate with it any information usefull for tracking or logging.</p>\n<h3>Deep link handler</h3>\n<p><code>DeepLinkHandler</code> protocol describes set of requirements for view controller (typically) to implement in order to take part in deep link handling process. It requires just one stored property and one method to implement.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">protocol</span> <span class=\"token class-name\">DeepLinkHandler</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// stores the current state of deeplink handling</span>\n    <span class=\"token keyword\">var</span> deeplinkHandling<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandling</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// attempts to handle deeplink and returns next state</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When implementing this protocol you will only care about these requirements, logic to handle state changes will be implemented in a default implementations in extension of this protocol. <code>open(deeplink:animated:)</code> method also is not intended to be called manually from your code - again it will be called from default implementation of the protocol.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token comment\">// Attempts to handle deeplink and updates its state, </span>\n    <span class=\"token comment\">// should be always called instead of method that returns state</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// you can track rejected or opened deeplinks here too</span>\n        deeplinkHandling <span class=\"token operator\">=</span> result\n        \n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">passedThrough</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">,</span> deeplink<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> result <span class=\"token punctuation\">{</span>\n            handler<span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">Void</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// Call to complete deeplink handling if it was delayed</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">complete</span><span class=\"token punctuation\">(</span>deeplinkHandling<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandling</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> deeplinkHandling <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">Void</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span>delayed<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>deeplinkHandling <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Simplest implementation of this protocol will just return <code>opened</code> or <code>rejected</code> states.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">RecipeFlowController</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> deeplink <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showRecipe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> recipeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token function\">showRecipe</span><span class=\"token punctuation\">(</span>withId<span class=\"token punctuation\">:</span> recipeId<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">opened</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// none of other deeplinks can be handled by this controller</span>\n            <span class=\"token comment\">// we can also do assertionFailure here</span>\n            <span class=\"token comment\">// because it's most likely programmer's error:</span>\n            <span class=\"token comment\">// either deeplink handling is missing</span>\n            <span class=\"token comment\">// or wrong screen was asked to handle deeplink</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>More complicated implementation with delayed handling and several screens involved in deep link handling:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">MyMenuNavigationController</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// if view is not loaded yet we should probably wait for it</span>\n        <span class=\"token keyword\">guard</span> isViewLoaded <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n            \n        <span class=\"token keyword\">switch</span> deeplink<span class=\"token punctuation\">.</span>intent <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> \n            <span class=\"token punctuation\">.</span><span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> subscriptionId<span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">showSubscriptions</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> subscriptionId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n            <span class=\"token keyword\">guard</span> subscriptions <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// wait until subscriptions are loaded somewhere else or trigger loading here</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> subscription <span class=\"token operator\">=</span> <span class=\"token function\">subscriptionWithId</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token function\">showSubscription</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">,</span> toOpen<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// we can return specific error to improve logging and tracking of errors</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token function\">noSuchSubscription</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">...</span>\n        <span class=\"token function\">complete</span><span class=\"token punctuation\">(</span>deeplinkHandling<span class=\"token punctuation\">:</span> deepLinkHandling<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">showSubscription</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> toOpen deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> subscriptionViewController <span class=\"token operator\">=</span> <span class=\"token function\">showSubscription</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// pass deeplink further to next screen</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">passedThrough</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">:</span> subscriptionViewController<span class=\"token punctuation\">,</span> deeplink<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">loadData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        dataProvider<span class=\"token punctuation\">.</span><span class=\"token function\">loadSubscriptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> subscriptions<span class=\"token punctuation\">,</span> error <span class=\"token keyword\">in</span>\n            <span class=\"token comment\">// at some point when we want to retry any delayed deeplink</span>\n            <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">complete</span><span class=\"token punctuation\">(</span>deeplinkHandling<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>deeplinkHandling<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">SubscriptionViewController</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> deeplink<span class=\"token punctuation\">.</span>intent <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showSubscription</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> week<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// navigate to requested view and do nothing</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">switchToWeekOrMenuId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>week<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> toOpen<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">,</span> completion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">opened</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> weekOrMenuId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// go to requested week and proceed to meal swap</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">switchToWeekOrMenuId</span><span class=\"token punctuation\">(</span>weekOrMenuId<span class=\"token punctuation\">,</span> toOpen<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">,</span> completion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span>\n                <span class=\"token keyword\">if</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>canEditMenu <span class=\"token operator\">==</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">showEditMenu</span><span class=\"token punctuation\">(</span>toOpen<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">opened</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>cantEditMenu<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">switchToWeekOrMenuId</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> weekOrMenuId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Either</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> toOpen deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">,</span> completion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> weekOrMenuId <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> week<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>week <span class=\"token operator\">!=</span> week <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">switchToWeek</span><span class=\"token punctuation\">(</span>week<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token function\">completion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">right</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span><span class=\"token punctuation\">:</span> menuId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> menu<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!=</span> menuId <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">getMenuWeekByMenuId</span><span class=\"token punctuation\">(</span>menuId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> week <span class=\"token keyword\">in</span>\n                    <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">switchToWeek</span><span class=\"token punctuation\">(</span>week<span class=\"token punctuation\">)</span>\n                    <span class=\"token comment\">//or we can transform link to one with week and try to open it</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token function\">completion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">switchedToWeek</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> week<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// called somewhere later when we navigated to requested week</span>\n        <span class=\"token function\">complete</span><span class=\"token punctuation\">(</span>deeplinkHandling<span class=\"token punctuation\">:</span> deeplinkHandling<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With this implementation it is more clear what deep links are handled on the screen, because they will be clearly stated in <code>switch</code>, and even how the state transitioning happens. Descriptive names for these states and additional console logs also improve debugging experience. Assertions that might be used here will help to catch bugs faster during development.</p>\n<h3>Deep links registration</h3>\n<p>Deep link routes registration should be clear of side effects (calling deep link handler to handle matched deep link) which can be performed implicitly by router (object that is responsible for keeping track of registered deep links routes and match them with incoming deep links, invoking registered handler closure as a side effect, consider mentioned JLRoutes as example). It makes testing deep links parsing much simpler.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">HFRoutes</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">JLRoutes</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"recipe/:recipeId\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">recipe</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"recipeId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">addAuthorized</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string-literal\"><span class=\"token string\">\"subscription/:subscriptionId/swap/:menuId\"</span></span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-literal\"><span class=\"token string\">\"subscription/:subscriptionId/:weekId/edit\"</span></span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span>\n\n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> subscriptionId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"subscriptionId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> menuId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"menuId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>menuId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> weekId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"weekId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> week <span class=\"token operator\">=</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> weekId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>week<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This can be also done in a more type safe manner without using strings for parameters names. This will help to avoid typos when defining pattern and parsing its parameters.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">DeepLinkPathComponent</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> recipeId\n    <span class=\"token keyword\">case</span> subscriptionId\n    <span class=\"token keyword\">case</span> menuId\n    <span class=\"token keyword\">case</span> weekId\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// some custom operators to build url patterns using strings and components</span>\n<span class=\"token comment\">// private to not pollute the scope of the rest of the app</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">lhs</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">/</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">rhs</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkPathComponent</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">lhs</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">/:</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">rhs<span class=\"token punctuation\">.</span>rawValue</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkPathComponent</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\":</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">lhs<span class=\"token punctuation\">.</span>rawValue</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">/</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">rhs</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">HFRoutes</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">parse</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">DeepLinkPathComponent</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> _params<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">DeepLinkPathComponent</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> params <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> component <span class=\"token operator\">=</span> <span class=\"token class-name\">DeepLinkPathComponent</span><span class=\"token punctuation\">(</span>rawValue<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">continue</span> <span class=\"token punctuation\">}</span>\n            _params<span class=\"token punctuation\">[</span>component<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span>describing<span class=\"token punctuation\">:</span> value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> _params\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">DeepLinkPathComponent</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Intent</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> routes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span> \n            <span class=\"token keyword\">return</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">:</span> params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">add</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"recipes\"</span></span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">.</span>recipeId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span> \n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> recipeId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>recipeId<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">recipe</span><span class=\"token punctuation\">(</span>recipeId<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">addAuthorized</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"subscription\"</span></span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">.</span>subscriptionId <span class=\"token operator\">/</span> <span class=\"token string-literal\"><span class=\"token string\">\"swap\"</span></span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">.</span>menuId<span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"subscription\"</span></span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">.</span>subscriptionId <span class=\"token operator\">/</span> <span class=\"token punctuation\">.</span>weekId <span class=\"token operator\">/</span> <span class=\"token string-literal\"><span class=\"token string\">\"edit\"</span></span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> subscriptionId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>subscriptionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> menuId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>menuId<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">:</span> subscriptionId<span class=\"token punctuation\">,</span> menuIdOrWeekId<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>menuId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> subscriptionId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>subscriptionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> weekId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>weekId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> week <span class=\"token operator\">=</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> weekId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">:</span> subscriptionId<span class=\"token punctuation\">,</span> menuIdOrWeekId<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>week<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>String path components can also be extracted to the enum but this will not give as much as in case of parameters which are most likely used repeatedly across different patterns.</p>\n<h3>Cold and warm start</h3>\n<p>To make deep link handling predictable no matter in what state the app is, handling deep link should always start from the same point - root handler. This root handler can be an app delegate (and mock in unit tests). To always start deep link handling with app delegate it should be stored as a week reference in a router:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">HFRoutes</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">weak</span> <span class=\"token keyword\">private</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> rootDeepLinkHandler<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandler</span><span class=\"token operator\">?</span>\n    \n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>rootDeepLinkHandler<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandler</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>rootDeepLinkHandler <span class=\"token operator\">=</span> rootDeepLinkHandler\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">registerRoutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">DeepLinkPathComponent</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Intent</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> routes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span> \n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> intent <span class=\"token operator\">=</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">:</span> params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> params<span class=\"token punctuation\">[</span><span class=\"token constant\">kJLRouteURLKey</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n            <span class=\"token keyword\">let</span> deeplink <span class=\"token operator\">=</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> url<span class=\"token punctuation\">,</span> intent<span class=\"token punctuation\">:</span> intent<span class=\"token punctuation\">)</span>\n            rootDeeplinkHandler<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">Void</span><span class=\"token operator\">?</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In case of cold start it's usual that the app needs to perform some launch routine, i.e. restore previously stored user session. During this routine you can present some <code>LaunchViewController</code> as a root view controller of the key window. In this case app delegate can handle deep links itself, delaying all of them until launch routine is finished. When launch is done app delegate completes its deep link handling and passes it through to newly installed root view controller (<code>HomeViewController</code>).</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">lazy</span> <span class=\"token keyword\">private</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> router<span class=\"token punctuation\">:</span> <span class=\"token class-name\">HFRoutes</span><span class=\"token operator\">!</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">HFRoutes</span><span class=\"token punctuation\">(</span>rootDeepLinkHandler<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> deeplink<span class=\"token punctuation\">.</span>intent <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span>registerForPushNotifications<span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// deeplinks which do not require any UI changes</span>\n            <span class=\"token comment\">// can be handled by app delegate itself</span>\n            <span class=\"token function\">registerForPushNotifications</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// all other deeplinks handling involves UI changes</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> deeplinkHandler <span class=\"token operator\">=</span> keyWindow<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>rootViewController <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">passedThrough</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">:</span> deeplinkHandler<span class=\"token punctuation\">,</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// can be called from LaunchViewController via delegate or trigerred with a notification</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunchingRoutine</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">complete</span><span class=\"token punctuation\">(</span>deeplinkHandling<span class=\"token punctuation\">:</span> deeplinkHandling<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In case of \"warm\" start <code>HomeViewController</code> will be already a root view controller, so app delegate will delegate deep link handling to it right away. <code>HomeViewController</code> can i.e. switch to correct tab and will pass deep link further.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">HomeViewController</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> deeplink<span class=\"token punctuation\">.</span>intent <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span>showRecipe<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">selectTab</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>explore<span class=\"token punctuation\">,</span> toOpen<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span>editMenu<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>showSubscription<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">selectTab</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>mymenu<span class=\"token punctuation\">,</span> toOpen<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">selectTab</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> tab<span class=\"token punctuation\">:</span> <span class=\"token class-name\">HomeTab</span><span class=\"token punctuation\">,</span> toOpen deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandling</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">selectTab</span><span class=\"token punctuation\">(</span>tab<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> deeplinkHandler <span class=\"token operator\">=</span> selectedViewController <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">passedThrough</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">:</span> deeplinkHandler<span class=\"token punctuation\">,</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This way the flow of deep link handling will be always predictable and application state (cold or warm start) related logic will be concentrated in one place in the app delegate.</p>\n<h3>Next steps</h3>\n<p>We can make one step further in the direction of removing side effects from the methods that handles deep links. By adding additional associated value of closure type to some <code>DeppLinkHandling</code> cases we can postpone a bit execution of the side effect required to handle a deep link and make <code>open(deeplink:animated) -> DeepLinkHandling</code> even more free of side effects. Side effect will be performed by default implementation of <code>open(deeplink:animated)</code> method. In unit tests we don't care about this method, unless we want to validate side effect itself, and to test logic in <code>open(deeplink:animated) -> DeepLinkHandling</code> becomes even simpler.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">DeepLinkHandling</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">opened</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Error</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">passedThrough</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">DeepLinkHandler</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">DeepLinkHandler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeepLink</span><span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// you can track rejected or opened deeplinks here too</span>\n        deeplinkHandling <span class=\"token operator\">=</span> result\n        \n        <span class=\"token keyword\">switch</span> result <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">opened</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">,</span> sideEffect<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token function\">sideEffect</span><span class=\"token punctuation\">(</span>animated<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">delayed</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span><span class=\"token punctuation\">,</span> sideEffect<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token function\">sideEffect</span><span class=\"token punctuation\">(</span>animated<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">passedThrough</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">,</span> sideEffect<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> handler <span class=\"token operator\">=</span> <span class=\"token function\">sideEffect</span><span class=\"token punctuation\">(</span>animated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                handler<span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>deeplink<span class=\"token punctuation\">:</span> deeplink<span class=\"token punctuation\">,</span> animated<span class=\"token punctuation\">:</span> animated<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">Void</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">break</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Bonus</h3>\n<p>Additionaly you can use Sourcery to code generate all the boilerplate. It can be also used to generate README file with supported links or html page to use for manual testing.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">Intent</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// sourcery: deeplink_route = recipe/:recipeId</span>\n    <span class=\"token comment\">// sourcery: deeplink_route = account/recipe/:recipeId</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">showRecipe</span><span class=\"token punctuation\">(</span>recipeId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\">// sourcery: deeplink_route = subscription/:subscriptionId/swap/:menuId</span>\n    <span class=\"token comment\">// sourcery: deeplink_authorized</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> menuId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\">// sourcery: deeplink_route = subscription/:subscriptionId/:week/edit</span>\n    <span class=\"token comment\">// sourcery: deeplink_authorized</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">editMenuForWeek</span><span class=\"token punctuation\">(</span>subscriptionId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> week<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// auto-generated code</span>\n\n<span class=\"token function\">add</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"recipe/:recipeId\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"account/recipe/:recipeId\"</span></span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span>\n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> recipeId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"recipeId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showRecipe</span><span class=\"token punctuation\">(</span>recipeId<span class=\"token punctuation\">:</span> recipeId<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">addAuthorized</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"subscription/:subscriptionId/swap/:menuId\"</span></span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span> \n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> subscroptionId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"subscriptionId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> menuId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"menuId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token function\">editMenu</span><span class=\"token punctuation\">(</span>subscritionId<span class=\"token punctuation\">:</span> subscriptionId<span class=\"token punctuation\">,</span> menuId<span class=\"token punctuation\">:</span> menuId<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">addAuthorized</span><span class=\"token punctuation\">(</span>routes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"subscription/:subscriptionId/:week/edit\"</span></span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> params <span class=\"token keyword\">in</span> \n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> subscriptionId <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"subscriptionId\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> week <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"week\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span> <span class=\"token function\">editMenuForWeek</span><span class=\"token punctuation\">(</span>subscritionId<span class=\"token punctuation\">:</span> subscriptionId<span class=\"token punctuation\">,</span> week<span class=\"token punctuation\">:</span> week<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Conclusion</h3>\n<p>With all this deep links code should become no brainer. It can be also a first step for implementing navigation in your app entirely based on the URLs, where <code>open(deeplink:animated)</code> method will become the main entry point of each controller. This will not only give you deep links support out of the box, but will also force you to isolate controllers from each other, minimising data flow between them.</p>\n<p>Tell me what you think in the comments!</p>","fields":{"slug":"/deeplinks-no-brainer/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f84","title":"Deep links with no brainer","date":"September 06, 2017","description":"Very often in my practice deep links were something that no one cares much, they work somehow and its fine. Or there are just few of them and its really not hard to maintain. But working for a long time on one product that targets several very different markets reveals all the importance of deep links in a long run. There are always requests from marketing teams to support new kind of deep link for a new marketing campaign, to open some new screen in the app from push notification, or with some specific parameters, when existing deep link can't be reused for what ever reason and you have to create yet another one for the same action. In the modern app there are also all kinds of different sources of urls that should act like a deep link to your app - universal links, push notifications, shortcut items etc.","tags":"iOS, Swift, Architecture"}},"previous":{"excerpt":"In Swift enums are much more powerful than we got used to in other languages. One of the features that makes them more interesting to use is associated valuesâ€¦","fields":{"slug":"/swift-enums-with-associated-values-defaults/"},"frontmatter":{"title":"Swift enums with associated values defaults","date":"March 24, 2017"}},"next":{"excerpt":"This is a short story of a regression in Swift 4 that I've recently had to deal with. It can seem as a simple problem, but I think it's a good example ofâ€¦","fields":{"slug":"/swift-4-tricky-filters/"},"frontmatter":{"title":"Swift 4 tricky filters","date":"September 26, 2017"}}},"pageContext":{"id":"5622e826-03a2-52ff-9ece-efd84781794f","previousPostId":"8240773d-746b-594a-97b1-1fdeddbdffdb","nextPostId":"be3abaac-6946-526e-b286-ac3176707924"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}