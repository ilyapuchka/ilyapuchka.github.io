{"componentChunkName":"component---src-templates-blog-post-js","path":"/xcode-source-editor-extension-superpowered-with-sourcekitten/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"2e9bac78-3f51-5094-a2a5-339d7444ea1e","excerpt":"With Xcode 8 Apple finally provided developers with first party API to develop plugin-like Xcode extensions, at the same time closing all the doors for inâ€¦","html":"<p>With Xcode 8 Apple finally provided developers with first party API to develop plugin-like Xcode extensions, at the same time closing all the doors for in-process plugins. At this moment unfortunately we are provided with a very limited tools. We can only manipulate the content of currently selected file, have no (official) access to any project metadata and other sources. There are also no first-party tools for code analysis, so we have to parse the code manually. Luckily thanks to OSS community we have such projects as SourceKitten that fills this gap and gives us some foundation to build cool stuff on top of it. Usually though it's used as a framework as part of other tools, usually command line tools that are supposed to be run from a build step of your project, not in source editor extension. Is it even possible to use SourceKitten in Xcode extension? Let's try.</p>\n<p>We go and create an Xcode source editor extension, link it with SourceKittenFramework and its dependencies, write some boilerplate implementation of extension command that uses one of SourceKitten APIs, like <code>Structure</code>. We run our extension and... we see in the console: <code>xcrun: error: cannot be used within an App Sandbox.</code></p>\n<p>Under the hood SourceKitten uses XPC service to communicate with SourceKit process, the same what Xcode does. It basically invokes <code>xcrun</code> command with different flags and parameters. And as that error message says this command can not be used within an App Sandbox. Xcode source editor extension though should be sandboxed.</p>\n<p>Luckily on MacOS we can run non-sandboxed apps unless we want to distribute them via App Store. In non-sandboxed app we can use SourceKitten without any problems.</p>\n<p>But if we try to turn off sandboxing for source editor extension it will simply not show up in <code>Editor</code> menu. So how can we run SourceKitten from non-sandboxed environment while being in a sandboxed environment of extension? The answer is - XPC service. XPC services everywhere! Instead of using SourceKitten directly we will access it through XPC service that will be <em>not sandboxed</em> and so can use SourceKitten.</p>\n<p>As our source editor extension is just an app extension it requires some MacOS app that will contain it. Extension in its turn will serve as a container for XPC service. The app itself can be as dumb as possible, it does not need to do anything, though it can be used as a settings interface for extension. The main actors will be an extension and it's accompanying XPC service.</p>\n<h3>Creating simple XPC service</h3>\n<p>So let's go through this setup step by step. First let's try to create a simple XPC service that our app can communicate with.</p>\n<blockquote>\n<p>I will not go into details of XPC service implementation, you can find everything you need to know in <a href=\"https://developer.apple.com/library/content/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingXPCServices.html\">docs</a>.</p>\n</blockquote>\n<p>Create a Cocoa Application and XPC Service target using Xcode templates. XPC Service template already contains everything that we need - it has a service protocol and its implementation that contains a simple function to uppercase input string, and comments on how to call the service from the app. Unfortunately there is no Swift version of this template, so we will need to rewrite it in Swift manually. Here is the code you should end up with.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// SourceKittenEditorExtensionService.xpc</span>\n<span class=\"token comment\">// SourceKittenEditorExtensionServiceProtocol.swift</span>\n\n<span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">protocol</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">uppercase</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> string<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> withReply<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// SourceKittenEditorExtensionService.xpc</span>\n<span class=\"token comment\">// SourceKittenEditorExtensionService.swift</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">Foundation</span>\n\n<span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SourceKittenEditorExtensionService</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">uppercase</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> string<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> withReply<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">withReply</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">.</span><span class=\"token function\">uppercased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// SourceKittenEditorExtensionService.xpc</span>\n<span class=\"token comment\">// main.swift</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">Foundation</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ServiceDelegate</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSXPCListenerDelegate</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">listener</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> listener<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSXPCListener</span><span class=\"token punctuation\">,</span> shouldAcceptNewConnection newConnection<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSXPCConnection</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Bool</span> <span class=\"token punctuation\">{</span>\n        newConnection<span class=\"token punctuation\">.</span>exportedInterface <span class=\"token operator\">=</span> <span class=\"token class-name\">NSXPCInterface</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> exportedObject <span class=\"token operator\">=</span> <span class=\"token class-name\">SourceKittenEditorExtensionService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        newConnection<span class=\"token punctuation\">.</span>exportedObject <span class=\"token operator\">=</span> exportedObject\n        newConnection<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Create the listener and resume it:</span>\n<span class=\"token keyword\">let</span> delegate <span class=\"token operator\">=</span> <span class=\"token class-name\">ServiceDelegate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> listener <span class=\"token operator\">=</span> <span class=\"token class-name\">NSXPCListener</span><span class=\"token punctuation\">.</span><span class=\"token function\">service</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nlistener<span class=\"token punctuation\">.</span>delegate <span class=\"token operator\">=</span> delegate<span class=\"token punctuation\">;</span>\nlistener<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// SourceKittenEditorExtensionApp.app</span>\n<span class=\"token comment\">// AppDelegate.swift</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">Cocoa</span>\n\n<span class=\"token attribute atrule\">@NSApplicationMain</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token attribute atrule\">@IBOutlet</span> <span class=\"token keyword\">weak</span> <span class=\"token keyword\">var</span> window<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSWindow</span><span class=\"token operator\">!</span>\n\n    <span class=\"token keyword\">lazy</span> <span class=\"token keyword\">var</span> connection<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSXPCConnection</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> connection <span class=\"token operator\">=</span> <span class=\"token class-name\">NSXPCConnection</span><span class=\"token punctuation\">(</span>serviceName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"my.company.SourceKittenEditorExtensionService\"</span></span><span class=\"token punctuation\">)</span>\n        connection<span class=\"token punctuation\">.</span>remoteObjectInterface <span class=\"token operator\">=</span> <span class=\"token class-name\">NSXPCInterface</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n        connection<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> connection\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> aNotification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> error <span class=\"token keyword\">in</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"remote proxy error: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">error</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> service <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">remoteObjectProxyWithErrorHandler</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span>\n        service<span class=\"token punctuation\">.</span><span class=\"token function\">uppercase</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"lowercase\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>uppercased<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>uppercased<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we need to enable Code Signing and App Sandboxing for both targets. As said before we will not use sandboxing for XPC Service to use SourceKitten, but at this point as we don't use SourceKitten yet you will see that everything still works and we get uppercased string!</p>\n<h3>Using SourceKitten in XPC service</h3>\n<p>Now let's try to use SourceKitten in our XPC service. Let's replace the method that we have in our service with another method to get a structure of source code.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// SourceKittenEditorExtensionService.xpc</span>\n<span class=\"token comment\">// SourceKittenEditorExtensionServiceProtocol.swift</span>\n\n<span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">protocol</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">structure</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> string<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> withReply<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\">// SourceKittenEditorExtensionService.xpc</span>\n<span class=\"token comment\">// SourceKittenEditorExtensionService.swift</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">SourceKittenFramework</span>\n\n<span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SourceKittenEditorExtensionService</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">structure</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> string<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> withReply<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> file <span class=\"token operator\">=</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span>contents<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> structure <span class=\"token operator\">=</span> <span class=\"token class-name\">Structure</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">:</span> file<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">withReply</span><span class=\"token punctuation\">(</span>structure<span class=\"token punctuation\">.</span>dictionary <span class=\"token keyword\">as</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// SourceKittenEditorExtensionApp.app</span>\n<span class=\"token comment\">// AppDelegate.swift</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">Cocoa</span>\n\n<span class=\"token attribute atrule\">@NSApplicationMain</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NSApplicationDelegate</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token attribute atrule\">@IBOutlet</span> <span class=\"token keyword\">weak</span> <span class=\"token keyword\">var</span> window<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSWindow</span><span class=\"token operator\">!</span>\n    \n    <span class=\"token keyword\">lazy</span> <span class=\"token keyword\">var</span> connection<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSXPCConnection</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> connection <span class=\"token operator\">=</span> <span class=\"token class-name\">NSXPCConnection</span><span class=\"token punctuation\">(</span>serviceName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"my.company.SourceKittenEditorExtensionService\"</span></span><span class=\"token punctuation\">)</span>\n        connection<span class=\"token punctuation\">.</span>remoteObjectInterface <span class=\"token operator\">=</span> <span class=\"token class-name\">NSXPCInterface</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n        connection<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> connection\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">applicationDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> aNotification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> error <span class=\"token keyword\">in</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"remote proxy error: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">error</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> service <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">remoteObjectProxyWithErrorHandler</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span>\n        service<span class=\"token punctuation\">.</span><span class=\"token function\">structure</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"struct Foo {}\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>structure<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>structure<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we need to add SourceKittenFramework and its dependencies to Embedded Binaries of the app and link them with XPC Service target. To make them available for XPC Service at runtime we also need to add runpath <code>@executable_path/../../../../Frameworks</code> in XPC Service build settings.</p>\n<p>If we run the app now we will see the error message <code>xcrun: error: cannot be used within an App Sandbox.</code> Go on and turn off sandboxing for XPC Service target (you need to delete entitlements file and clear Code Signing Entitlements build setting first). If you run the app again you will see that it works and you will see parsed code structure!</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[\"key.diagnostic_stage\": source.diagnostic.stage.swift.parse, \"key.substructure\": &lt;__NSSingleObjectArrayI 0x7f8805f11b50>(\n{\n    \"key.accessibility\" = \"source.lang.swift.accessibility.internal\";\n    \"key.bodylength\" = 0;\n    \"key.bodyoffset\" = 12;\n    \"key.kind\" = \"source.lang.swift.decl.struct\";\n    \"key.length\" = 13;\n    \"key.name\" = Foo;\n    \"key.namelength\" = 3;\n    \"key.nameoffset\" = 7;\n    \"key.offset\" = 0;\n}\n)\n, \"key.offset\": 0, \"key.length\": 13]</code></pre></div>\n<h3>Xcode source editor extension</h3>\n<p>Now when we have XCP Service for SourceKitten let's use it in source editor extension instead of the app.</p>\n<p>Go on and add Xcode Source Editor Extension target from Xcode template. Move the code to communicate with the service from the app to extension command code. Here is the code of extension that you should end up with. As you can see it's exactly the same as code that calls XPC Service from the app and service code does not change at all.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// SourceKittenEditorExtension.appex</span>\n<span class=\"token comment\">// SourceEditorExtension.swift</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">Foundation</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">XcodeKit</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SourceEditorExtension</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">XCSourceEditorExtension</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">extensionDidFinishLaunching</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// If your extension needs to do any work at launch, implement this optional method.</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"extension launched\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">/*\n    var commandDefinitions: [[XCSourceEditorCommandDefinitionKey: Any]] {\n        // If your extension needs to return a collection of command definitions that differs from those in its Info.plist, implement this optional property getter.\n        return []\n    }\n    */</span>\n    \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// SourceKittenEditorExtension.appex</span>\n<span class=\"token comment\">// SourceEditorCommand.swift</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">Foundation</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">XcodeKit</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SourceEditorCommand</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">XCSourceEditorCommand</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">lazy</span> <span class=\"token keyword\">var</span> connection<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSXPCConnection</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> connection <span class=\"token operator\">=</span> <span class=\"token class-name\">NSXPCConnection</span><span class=\"token punctuation\">(</span>serviceName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"my.company.SourceKittenEditorExtensionService\"</span></span><span class=\"token punctuation\">)</span>\n        connection<span class=\"token punctuation\">.</span>remoteObjectInterface <span class=\"token operator\">=</span> <span class=\"token class-name\">NSXPCInterface</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n        connection<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> connection\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">deinit</span> <span class=\"token punctuation\">{</span>\n        connection<span class=\"token punctuation\">.</span><span class=\"token function\">invalidate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">perform</span><span class=\"token punctuation\">(</span>with invocation<span class=\"token punctuation\">:</span> <span class=\"token class-name\">XCSourceEditorCommandInvocation</span><span class=\"token punctuation\">,</span> completionHandler<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> error <span class=\"token keyword\">in</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"remote proxy error: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">error</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> service <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">remoteObjectProxyWithErrorHandler</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token class-name\">SourceKittenEditorExtensionServiceProtocol</span>\n        service<span class=\"token punctuation\">.</span><span class=\"token function\">structure</span><span class=\"token punctuation\">(</span>invocation<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">.</span>completeBuffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>structure<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>structure<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">completionHandler</span><span class=\"token punctuation\">(</span><span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now remove the XPC Service from the app embedded binaries and add a Copy Files build phase in extension target to copy XPC Service to <code>XPC Services</code> directory. Add XPC Service target as a Target Dependency for extension target. As now XPC Service is embedded in the extension which is in turn is embedded in the app we need to adjust its runpath to <code>@executable_path/../../../../../../../Frameworks</code>.</p>\n<p>Now when you run the extension (if you have a good day it will show up in <code>Editor</code> menu) and select its menu item you will see it's working like a charm!</p>\n<blockquote>\n<p>If something does not work as expected when you run the app or extension (extension menu does not show up, app fails to connect to service or fails to locate its binary), start from the beginning... My experience shows that it's easier and faster than trying to find the issue. If extension does not do anything (you don't see any output in the console) stop and run it again, for me it works only every second time.</p>\n</blockquote>\n<p>Now we have SourceKitten superpowers in our source editor extension and with it we can do much more than before as we now have (almost complete) information about source code structure and we don't need to parse source code manually, it's much simpler to parse JSON that we now have.</p>\n<p>You can get all the source code of this extension <a href=\"https://github.com/ilyapuchka/SourceKittenEditorExtension\">here</a>.</p>\n<blockquote>\n<p>Thanks to Norio Nomura for sharing his implementation of extension that uses SourceKitten in his repo. I used it as a reference. <a href=\"https://github.com/norio-nomura/LinuxSupportForXcode/\">https://github.com/norio-nomura/LinuxSupportForXcode/</a></p>\n</blockquote>","fields":{"slug":"/xcode-source-editor-extension-superpowered-with-sourcekitten/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f82","title":"Xcode Source Editor Extension superpowered with SourceKitten","date":"February 19, 2017","description":"With Xcode 8 Apple finally provided developers with first party API to develop plugin-like Xcode extensions, at the same time closing all the doors for in-process plugins. At this moment unfortunately we are provided with a very limited tools. We can only manipulate the content of currently selected file, have no (official) access to any project metadata and other sources. There are also no first-party tools for code analysis, so we have to parse the code manually. Luckily thanks to OSS community we have such projects as SourceKitten that fills this gap and gives us some foundation to build cool stuff on top of it. Usually though it's used as a framework as part of other tools, usually command line tools that are supposed to be run from a build step of your project, not in source editor extension. Is it even possible to use SourceKitten in Xcode extension? Let's try.","tags":""}},"previous":{"excerpt":"This week there were a lot of articles around the web about React Native and its place in a current iOS dev ecosystem. I was also playing with JavaScript latelyâ€¦","fields":{"slug":"/extending-native-code-with-javascriptcore/"},"frontmatter":{"title":"Extending native code with JavaScriptCore","date":"February 08, 2017"}},"next":{"excerpt":"In Swift enums are much more powerful than we got used to in other languages. One of the features that makes them more interesting to use is associated valuesâ€¦","fields":{"slug":"/swift-enums-with-associated-values-defaults/"},"frontmatter":{"title":"Swift enums with associated values defaults","date":"March 24, 2017"}}},"pageContext":{"id":"2e9bac78-3f51-5094-a2a5-339d7444ea1e","previousPostId":"e82bd09f-d3c1-5a91-9437-3a40bcf7795c","nextPostId":"8240773d-746b-594a-97b1-1fdeddbdffdb"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}