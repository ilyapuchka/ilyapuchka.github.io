{"componentChunkName":"component---src-templates-blog-post-js","path":"/intermediate-action-segues/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"fee58a6f-fcfc-5712-adc6-5f7de0b5a601","excerpt":"TL;DR - You can play with source code and example project here. Storyboards segues are very cool. They are very easy yet powerful. They help to incapsulate…","html":"<blockquote>\n<p>TL;DR - You can play with source code and example project <a href=\"https://github.com/ilyapuchka/IntermediateActionSegue\">here</a>.</p>\n</blockquote>\n<p>Storyboards segues are very cool. They are very easy yet powerful. They help to incapsulate presentation logic and move it out from view controllers. And adaptive segues are state of the art. There is only one thing (almost) left if view controller - managing segue performance using those two commonly used methods:</p>\n<ul>\n<li><code>func shouldPerformSegueWithIdentifier(identifier: String, sender: AnyObject?) -> Bool</code></li>\n<li><code>func prepareForSegue(segue: UIStoryboardSegue, sender: AnyObject?)</code></li>\n</ul>\n<p>And those methods are the place where we usually screw up everything with our custom logic based on tons of <code>if</code> or <code>switch</code> statements. Then we introduce different routers, coordinators and God knows what else (though they are all nice and interesting concepts), forgetting that we can just subclass a segue and do it not only to pass data around.</p>\n<p>There is very common use case. You want to present some view only if user has been authorized in your application. If not then you what to show login form. Or register form with subsequent Terms of Use that user has to agree to in order to use your service. It is already a whole storyboard to be displayed in between.</p>\n<p>You can do that with several <code>if</code>s if you have it in one place. But what if you have few places in your app where you need to authorize user before doing something?</p>\n<p>Lets see how we can do that with custom segue. I will call this segue an <code>IntermediateActionSegue</code>.</p>\n<p>Here are our design goals:</p>\n<ul>\n<li>segue should know nothing about current application context and application (view controllers) should know as little as possible about their presentation context (for instance that they were presented as intermediate controllers)</li>\n<li>segue should support different kinds of presentation style like modal, fullscreen, popover and custom</li>\n<li>segue should be adaptive</li>\n<li>there should be a way to present single view controller or a storyboard as intermediate action</li>\n<li>segue API should look like UIKit API, meaning that client code should be able to change presentation using delegate callbacks</li>\n</ul>\n<p>Actually implementation of such segue is straight forward. All we need to do is to ask some delegate, custom object (that can be your lovely router, coordinator or what ever else) or simply segue's <code>sourceViewController</code>, to provide us with intermediate view controller, that we need to present instead of <code>destinationViewController</code>, and with its presentation style. For that we will use a protocol:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">protocol</span> <span class=\"token class-name\">IntermediateActionPresentationDelegate</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">intermediateViewControllerForSegue</span><span class=\"token punctuation\">(</span>segue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIStoryboardSegue</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">UIViewController</span><span class=\"token operator\">?</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">intermediateViewControllerPresentationStyleForSegue</span><span class=\"token punctuation\">(</span>segue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIStoryboardSegue</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">IntermediateActionSeguePresentationStyle</span>\n    \n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">willPresentIntermediateViewController</span><span class=\"token punctuation\">(</span>segue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIStoryboardSegue</span><span class=\"token punctuation\">,</span> intermediateViewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIViewController</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">intermediateViewControllerCompleted</span><span class=\"token punctuation\">(</span>intermediateViewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIViewController</span><span class=\"token punctuation\">,</span> success<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span><span class=\"token punctuation\">,</span> completionData<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Bool</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When that intermediate view controller completes its task we let the segue that presented it to know about that and depending on the result, success or failure, segue will complete itself dismissing intermediate view controllers and presenting <code>destinationViewController</code> or abort. For that we need to keep a reference to segue in a view controller. We can use associated object to add this property to any view controller in extension:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">UIViewController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">AssociatedKeys</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> segueKey <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">private</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> intermediateActionSegue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IntermediateActionSegue</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">get</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">objc_getAssociatedObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">AssociatedKeys</span><span class=\"token punctuation\">.</span>segueKey<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">IntermediateActionSegue</span> <span class=\"token operator\">??</span> storyboard<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>intermediateActionSegue\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">objc_setAssociatedObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">AssociatedKeys</span><span class=\"token punctuation\">.</span>segueKey<span class=\"token punctuation\">,</span> newValue<span class=\"token punctuation\">,</span> objc_AssociationPolicy<span class=\"token punctuation\">.</span><span class=\"token constant\">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note that if we want to present intermediate storyboards we kind of loose control of the flow while we are on that storyboard. For instance we can not pass reference to segue that caused this storyboard to appear between view controllers of that storyboard. Technically we can but it will break our first design goal. So we additionally store reference to segue in storyboard when we present \"initial\" intermediate view controller again using associated object and extension.</p>\n<p>The only difficulty is to handle different presentations that could happen along the way. But there are usually only two alternative variants - either intermediate controllers are presented modally or in navigation controller.</p>\n<h4>Conclusion</h4>\n<p>Of course that is neither an ideal nor the only one possible solution, there is still a room for improvements here. Using this kind of segue you will still sometimes need to switch on segues identifiers or something else to setup presentation logic or check conditions to display intermediate view controllers. But at least you will have few options here. You can use either extension of view controller or separate delegate object to define presentation and business rules. Or you can easily subclass this segue.</p>\n<p>What I think is good is that now you can easily use any view controller or even storyboard as intermediate and they don't know almost nothing (except calling completion method on a segues) about how they are used. Your view controllers will communicate with intermediate controllers by well defined interface, separate from handling all other segues. When you move handling those segues in extension or separate object, that will make your view controller a bit cleaner.</p>\n<p>You can play with source code and example project <a href=\"https://github.com/ilyapuchka/IntermediateActionSegue\">here</a>.</p>","fields":{"slug":"/intermediate-action-segues/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f6f","title":"Intermediate action segues","date":"December 27, 2015","description":"Storyboards segues are very cool. They are very easy yet powerful. They help to incapsulate presentation logic and move it out from view controllers. And adaptive segues are state of the art. There is only one thing (almost) left if view controller...","tags":""}},"previous":{"excerpt":"In Objective-C it's very natural to have a property of type that also conforms to one or few protocols. In Swift that becomes tedious cause you can not simply…","fields":{"slug":"/properties-of-types-conforming-to-protocols-in-swift/"},"frontmatter":{"title":"Properties of types conforming to protocols in Swift","date":"December 25, 2015"}},"next":{"excerpt":"OS X developers are kind of rare developer species. I don't know about you but among my fellow developers there is only one who is doing OS X. I'm not sure if…","fields":{"slug":"/creating-simple-os-x-app/"},"frontmatter":{"title":"Creating a simple OS X app","date":"March 24, 2016"}}},"pageContext":{"id":"fee58a6f-fcfc-5712-adc6-5f7de0b5a601","previousPostId":"e74e6ff6-3719-52e2-bd36-9675a155af90","nextPostId":"ea9adc21-c3f5-5eca-a0ba-9023e234a979"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}