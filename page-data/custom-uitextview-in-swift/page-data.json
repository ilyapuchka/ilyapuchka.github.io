{"componentChunkName":"component---src-templates-blog-post-js","path":"/custom-uitextview-in-swift/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"ed4c5872-112e-562b-9154-9d9acb635f77","excerpt":"In this article I want to describe how I developed custom UITextView component in Swift using TextKit, Playgrounds and IBDesignable and IBInspectable directives…","html":"<p>In this article I want to describe how I developed custom UITextView component in Swift using TextKit, Playgrounds and IBDesignable and IBInspectable directives. You can check out source code on <a href=\"https://github.com/ilyapuchka/ReadMoreTextView\">github</a>.</p>\n<!-- description -->\n<p>In this component we will add \"read more\" behaviour to text view. It will have two modes - full mode and trimmed mode. In full mode it will behave like standard UITextView. In trimmed mode it will trim text to some maximum numbers of lines and trim text with a string (like \"Read more\"). When user taps on \"Read more\" the component will switch from trimmed mode to full mode.</p>\n<h4>Creating playgroud</h4>\n<p>As I said earlier we will develop this component directly in Swift Playgroud. In Playgrouds we can render any view in Assistant Editor with help of XCPlayground module and it's XCPShowView function. To make it work we need to open playground's File Inspector (⌥-⌘-1). In File Inspector in Playground Settings we should check \"Run in Full Simulator\". Now hide File Inspector (⌥-⌘-0) and open Assistant Editor (⌥-⌘-⏎).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 260px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/21d4977e767a41445249454671cebed3/86c28/checkmark.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.351351351351354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABEklEQVR42m2Q207CQBCG+8S+kU/hpYkE0ERQKbScwm7b0G1BpGV7CtRI+5mt8cLESb7MZA7/TMZynBmDfp/xaIRt27y8vvH0OOR5NGYwGKJURJZlpGnK6XT6F1O7VDmx2mKlSYLneQRBgFIKFUWEYUioYoSQXXNVVRRFQVmUP74s/1IUBMcLYrvDKsuKuq7J85zpbMZ0MmG13pBnGl8K4t0BY03T0LZtB7/e5K9X2uaLmzu47b9jmY1GzKCzjMScX2p664oHO8QXK6J4j+/7SOkhPR/peV0shOj6tdbYwZm52GF1Qlp3mF/pLKeuNPfLkp77gVy7+IFCSI/lcsVGSBaLBY7jMnfnHJOkm/08Fxz2Ed8f+XC86Iz2nAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"checkmark\"\n        title=\"\"\n        src=\"/static/21d4977e767a41445249454671cebed3/86c28/checkmark.png\"\n        srcset=\"/static/21d4977e767a41445249454671cebed3/12f09/checkmark.png 148w,\n/static/21d4977e767a41445249454671cebed3/86c28/checkmark.png 260w\"\n        sizes=\"(max-width: 260px) 100vw, 260px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Recently I wrote <a href=\"http://ilya.puchka.me/quick-overview-of-swift-playgrounds-in-ios-simulator/%22\">a small overview</a> about using this feature of playgrounds.</p>\n<h4>Creating main view</h4>\n<p>To display something in Assistant Editor we will create a main view. Let's define a function that will create and return this view.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">createView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">UIView</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> view <span class=\"token operator\">=</span> <span class=\"token class-name\">UIView</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIScreen</span><span class=\"token punctuation\">.</span><span class=\"token function\">mainScreen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>bounds<span class=\"token punctuation\">)</span>\n    view<span class=\"token punctuation\">.</span>backgroundColor <span class=\"token operator\">=</span> <span class=\"token class-name\">UIColor</span><span class=\"token punctuation\">.</span><span class=\"token function\">greenColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> view\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we can display this view in Assistant Editor:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">UIKit</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">XCPlayground</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">createView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">UIView</span> <span class=\"token punctuation\">{</span>\n<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">XCPShowView</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"view\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">createView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Here is what you should see:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b8bbad8746971c9b38b6d6f74bfe1719/f2331/Assistant-Editor.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABYklEQVR42s2Su04cMRSGR6KOAkrqKDwDPeQpaBGvgGjCpQo1hCiQHkWBHqVOuHSICuUlmJnd9cz4cjxrf5G9LAkSEYrS5Ehf4WP782/ZRVXe0nQK6wxWDOKFGCIxRpxzaK0zIoL3nthH6CEawJPHqZ9I6wtVK0Z1i2kF3Qri+ixMNRwOs8xaSwhjYoAf8pUzu8+l+cS5+cC1+8I49IQQcpjCaosXQdLpd8mmlWTGGKyzRCb9I73M2qhgq5ljfTTDbrtAiH2eSykLmEh+F00rXTML7S/hsVllQz1np3nNlnrBQbdE4IHwz/W4cIW36hnvmldsqlk+dov/gTC93lR4YlazaKeZZ1u95LB7828Jj8wya+ruUdQMu93C3wsT3gu9H3NjTvmm97jQh3zX77kynxHvJv9Q3NPClC6Rrp0IEkC4J0q8n8sfe7rhMZRSDAYDqqqirutMVZeU9e0Dcr8saduWn2GqM+8n5pZCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Assistant Editor\"\n        title=\"\"\n        src=\"/static/b8bbad8746971c9b38b6d6f74bfe1719/fcda8/Assistant-Editor.png\"\n        srcset=\"/static/b8bbad8746971c9b38b6d6f74bfe1719/12f09/Assistant-Editor.png 148w,\n/static/b8bbad8746971c9b38b6d6f74bfe1719/e4a3f/Assistant-Editor.png 295w,\n/static/b8bbad8746971c9b38b6d6f74bfe1719/fcda8/Assistant-Editor.png 590w,\n/static/b8bbad8746971c9b38b6d6f74bfe1719/efc66/Assistant-Editor.png 885w,\n/static/b8bbad8746971c9b38b6d6f74bfe1719/c83ae/Assistant-Editor.png 1180w,\n/static/b8bbad8746971c9b38b6d6f74bfe1719/f2331/Assistant-Editor.png 1427w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h4>Component's interface</h4>\n<p>As mentioned earlier we want our component to have maximum number of lines in trimmed mode and a string to trim text. Also we will add a flag to turn trimming on and off. So let's define some basic interface for our component:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ReadMoreTextView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UITextView</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">var</span> maximumNumberOfLines<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">var</span> trimText<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSString</span><span class=\"token operator\">?</span>\n    <span class=\"token keyword\">var</span> shouldTrim<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Changing any of these properties should cause our text view to update it's layout so we need to add property observers for them:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">var</span> maximumNumberOfLines<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">didSet</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">setNeedsLayout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> trimText<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSString</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">didSet</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">setNeedsLayout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> shouldTrim<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">didSet</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">setNeedsLayout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">needsTrim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Bool</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> shouldTrim <span class=\"token operator\">&amp;&amp;</span> trimText <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">layoutSubviews</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">layoutSubviews</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">needsTrim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">updateText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token function\">resetText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">updateText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//update text view</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">resetText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//reset text view</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Adding component to main view</h4>\n<p>To continue we need to see how our text view is rendered so we need to add it to our main view that is displayed in Assistant Editor. We can modify <code>createView</code> function to accept text view as it's argument and to add it on screen:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">createView</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">:</span> <span class=\"token class-name\">TextView</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">UIView</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">let</span> view <span class=\"token operator\">=</span> <span class=\"token class-name\">UIView</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIScreen</span><span class=\"token punctuation\">.</span><span class=\"token function\">mainScreen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>bounds<span class=\"token punctuation\">)</span>\n    view<span class=\"token punctuation\">.</span>backgroundColor <span class=\"token operator\">=</span> <span class=\"token class-name\">UIColor</span><span class=\"token punctuation\">.</span><span class=\"token function\">greenColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    view<span class=\"token punctuation\">.</span><span class=\"token function\">addSubview</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> metrics <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"padding\"</span></span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">]</span>\n\n    view<span class=\"token punctuation\">.</span><span class=\"token function\">addConstraints</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NSLayoutConstraint</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">constraintsWithVisualFormat</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"V:|-padding-[textView]-padding-|\"</span></span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">,</span>\n            metrics<span class=\"token punctuation\">:</span> metrics<span class=\"token punctuation\">,</span>\n            views<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"textView\"</span></span><span class=\"token punctuation\">:</span> textView<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    view<span class=\"token punctuation\">.</span><span class=\"token function\">addConstraints</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NSLayoutConstraint</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">constraintsWithVisualFormat</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"H:|-padding-[textView]-padding-|\"</span></span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">,</span>\n        metrics<span class=\"token punctuation\">:</span> metrics<span class=\"token punctuation\">,</span>\n        views<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"textView\"</span></span><span class=\"token punctuation\">:</span> textView<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> view\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> textView <span class=\"token operator\">=</span> <span class=\"token class-name\">ReadMoreTextView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\ntextView<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"Lorem ipsum dolor sit er elit lamet, consectetaur cillium adipisicing pecu, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Nam liber te conscient to factor tum poen legum odioque civiuda.\"</span></span>\n\ntextView<span class=\"token punctuation\">.</span>maximumNumberOfLines <span class=\"token operator\">=</span> <span class=\"token number\">3</span>\ntextView<span class=\"token punctuation\">.</span>shouldTrim <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\ntextView<span class=\"token punctuation\">.</span>trimText <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"Read more\"</span></span>\n\n<span class=\"token class-name\">XCPShowView</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"view\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">createView</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4>Extending TextKit</h4>\n<p>To trim text we need first find the range of text that fits to <code>maximumNumberOfLines</code>. To do so we will use TextKit. UITextView already uses it to render it's text on screen and has built in components like text container, text storage and layout manager. I will not go through details of TextKit, for more details on TextKit check out <a href=\"http://www.objc.io/issue-5/getting-to-know-textkit.html\">objc.io</a> or <a href=\"https://developer.apple.com/library/ios/documentation/StringsTextFonts/Conceptual/TextAndWebiPhoneOS/CustomTextProcessing/CustomTextProcessing.html\">documentation</a>.</p>\n<p>In NSLayoutManager's extention we will define two simple helper functions: first to find characters range that fits in text container and second to find bounding rectangle of characters range:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">NSLayoutManager</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">characterRangeThatFits</span><span class=\"token punctuation\">(</span>textContainer<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSTextContainer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NSRange</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> rangeThatFits <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">glyphRangeForTextContainer</span><span class=\"token punctuation\">(</span>textContainer<span class=\"token punctuation\">)</span>\n        rangeThatFits <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">characterRangeForGlyphRange</span><span class=\"token punctuation\">(</span>rangeThatFits<span class=\"token punctuation\">,</span> actualGlyphRange<span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> rangeThatFits\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">boundingRectForCharacterRange</span><span class=\"token punctuation\">(</span>range<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSRange</span><span class=\"token punctuation\">,</span> inTextContainer textContainer<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSTextContainer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">CGRect</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> glyphRange <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">glyphRangeForCharacterRange</span><span class=\"token punctuation\">(</span>range<span class=\"token punctuation\">,</span> actualCharacterRange<span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> boundingRect <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">boundingRectForGlyphRange</span><span class=\"token punctuation\">(</span>glyphRange<span class=\"token punctuation\">,</span> inTextContainer<span class=\"token punctuation\">:</span> textContainer<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> boundingRect\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Trimming text</h4>\n<p>Before updating text and trimming it we need to make sure that we can restore text view to it's full state when text should not be trimmed. For that we will store text and attributed text in private properties:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> originalText<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">override</span> <span class=\"token keyword\">var</span> text<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">!</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">didSet</span> <span class=\"token punctuation\">{</span>\n        originalText <span class=\"token operator\">=</span> text\n        originalAttributedText <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n        <span class=\"token keyword\">if</span> <span class=\"token function\">needsTrim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">updateText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> originalAttributedText<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSAttributedString</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">override</span> <span class=\"token keyword\">var</span> attributedText<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSAttributedString</span><span class=\"token operator\">!</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">didSet</span> <span class=\"token punctuation\">{</span>\n        originalAttributedText <span class=\"token operator\">=</span> attributedText\n        originalText <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n        <span class=\"token keyword\">if</span> <span class=\"token function\">needsTrim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">updateText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When we does not need to trim text we reset text view to full mode and restore it's text:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">resetText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    textContainer<span class=\"token punctuation\">.</span>maximumNumberOfLines <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">if</span> originalText <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">{</span>\n        textStorage<span class=\"token punctuation\">.</span><span class=\"token function\">replaceCharactersInRange</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NSMakeRange</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token function\">countElements</span><span class=\"token punctuation\">(</span>text<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> withString<span class=\"token punctuation\">:</span> originalText<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> originalAttributedText <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">{</span>\n        textStorage<span class=\"token punctuation\">.</span><span class=\"token function\">replaceCharactersInRange</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NSMakeRange</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token function\">countElements</span><span class=\"token punctuation\">(</span>text<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> withAttributedString<span class=\"token punctuation\">:</span> originalAttributedText<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next we add function to find range of text to replace with \"Read more\":</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">rangeToReplaceWithTrimText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NSRange</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> emptyRange <span class=\"token operator\">=</span> <span class=\"token class-name\">NSMakeRange</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NSNotFound</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">var</span> rangeToReplace <span class=\"token operator\">=</span> layoutManager<span class=\"token punctuation\">.</span><span class=\"token function\">characterRangeThatFits</span><span class=\"token punctuation\">(</span>textContainer<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token class-name\">NSMaxRange</span><span class=\"token punctuation\">(</span>rangeToReplace<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token function\">originalTextLength</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        rangeToReplace <span class=\"token operator\">=</span> emptyRange\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        rangeToReplace<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> <span class=\"token class-name\">NSMaxRange</span><span class=\"token punctuation\">(</span>rangeToReplace<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> trimText<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">4</span>\n        <span class=\"token keyword\">if</span> rangeToReplace<span class=\"token punctuation\">.</span>location <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n            rangeToReplace <span class=\"token operator\">=</span> emptyRange\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            rangeToReplace<span class=\"token punctuation\">.</span>length <span class=\"token operator\">=</span> textStorage<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> rangeToReplace<span class=\"token punctuation\">.</span>location\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> rangeToReplace\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> _originalTextLength<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">get</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> originalText <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">countElements</span><span class=\"token punctuation\">(</span>originalText<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> originalAttributedText <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> originalAttributedText<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>length\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we increase range by 4 to be able to add \"... \" as a prefix for trim text later. If we don't need to trim text eigther if we have too small text or too big <code>maximumNumberOfLines</code> then we return empty range.</p>\n<p>Finally let's add code that will trim text:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">updateText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    textContainer<span class=\"token punctuation\">.</span>maximumNumberOfLines <span class=\"token operator\">=</span> maximumNumberOfLines\n    layoutManager<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateLayoutForCharacterRange</span><span class=\"token punctuation\">(</span>layoutManager<span class=\"token punctuation\">.</span><span class=\"token function\">characterRangeThatFits</span><span class=\"token punctuation\">(</span>textContainer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> actualCharacterRange<span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span>\n    textContainer<span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> <span class=\"token class-name\">CGSizeMake</span><span class=\"token punctuation\">(</span>bounds<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">.</span>max<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">var</span> range <span class=\"token operator\">=</span> <span class=\"token function\">rangeToReplaceWithTrimText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> range<span class=\"token punctuation\">.</span>location <span class=\"token operator\">!=</span> <span class=\"token class-name\">NSNotFound</span> <span class=\"token punctuation\">{</span>\n        textStorage<span class=\"token punctuation\">.</span><span class=\"token function\">replaceCharactersInRange</span><span class=\"token punctuation\">(</span>range<span class=\"token punctuation\">,</span> withString<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"... \"</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">stringByAppendingString</span><span class=\"token punctuation\">(</span>trimText<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">invalidateIntrinsicContentSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>First we set maximum number of lines in text container and it's size so that bounding rectange of this text container will have the width of text view and unlimited height. We also have to invalidate layout information to properly calculate the range of text to trim. Then we find the range that we should replace with \"Read more\" text and if it's not empty we replace text in this range with <code>trimText</code> prefixed by \"... \"</p>\n<h4>Autolayout</h4>\n<p>When text view is in trim mode it needs to wrap it's content and become smaller than in full mode. To do so we need to redefine it's intrinsic content size.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">intrinsicContentSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">CGSize</span> <span class=\"token punctuation\">{</span>\n    textContainer<span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> <span class=\"token class-name\">CGSizeMake</span><span class=\"token punctuation\">(</span>bounds<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">.</span>max<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> intrinsicContentSize <span class=\"token operator\">=</span> layoutManager<span class=\"token punctuation\">.</span><span class=\"token function\">boundingRectForGlyphRange</span><span class=\"token punctuation\">(</span>layoutManager<span class=\"token punctuation\">.</span><span class=\"token function\">glyphRangeForTextContainer</span><span class=\"token punctuation\">(</span>textContainer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> inTextContainer<span class=\"token punctuation\">:</span> textContainer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>size\n    intrinsicContentSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token class-name\">UIViewNoIntrinsicMetric</span>\n    intrinsicContentSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>textContainerInset<span class=\"token punctuation\">.</span>top <span class=\"token operator\">+</span> textContainerInset<span class=\"token punctuation\">.</span>bottom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> intrinsicContentSize\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>First we set text container's size, again unlimited by height, then we find bounding rect for all text in this text container and take it's size. We don't need intrinsic size on width, so we set it to <code>UIViewNoIntrinsicMetric</code>. And we increase height by top and bottom insets of text container.</p>\n<p>Aslo we need to update vertical constraints in <code>createView</code> and invalidate intrinsic size:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">updateText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token function\">invalidateIntrinsicContentSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">resetText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token function\">invalidateIntrinsicContentSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token operator\">...</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">createView</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UITextView</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">UIView</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    view<span class=\"token punctuation\">.</span><span class=\"token function\">addConstraints</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NSLayoutConstraint</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">constraintsWithVisualFormat</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"V:|-padding-[textView]-(>=padding)-|\"</span></span><span class=\"token punctuation\">,</span>\n            options<span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">,</span>\n            metrics<span class=\"token punctuation\">:</span> metrics<span class=\"token punctuation\">,</span>\n            views<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"textView\"</span></span><span class=\"token punctuation\">:</span> textView<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Initialization</h4>\n<p>Though we've done everything we need to make our text view work properly if you look now in Assistant Editor you will probably see something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3ea8ca711570d31702b6e5b47ccb2534/7762d/UITextView-bug.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABy0lEQVR42u2TzWsTQRjGQ/Ci1Ytiwc+zBw9e/MT/QEQwRXrRc7F6UHMwpmJyFIVWT8XEQvwoHj36JwgiIm0tBk3WrqjU7m52ZjY722TnJ7sJYlJB7zrw8L7MzPPjPTxvxnYjlI7xwxgRJrWLHVp8DJdohO9o6mXqcoG6Wkj7RqJwCbttpX97nhipY77LDhk36JAcY0xaNT5zXo6aNcHTlcs8/jTJfFKtSZ6sXKLWmOBR8yJzfo6AtZ6XnjfQXTJOHxj3gZJVnrtFll/ZvH/9Oa3NxVXqb77w4e03Fl9auFbEi6iMG9s9bx+oEuCGCY2gok4z65zhoXeOipuj6o5R9cZ4sHaWipOjFoxTCU4RGGfjhMPAddNmWh0mLzZRkFu5Lkf62kJBjXBDbeOqn+WuPIQ28s/AyATcVyeY8kcpi32UxF7KffX6/dwUo8zIo4TG/zvgPXWcor+DktjNLbFrQCWxh6LYzrQ8QmjEf+C/CRxePZ3m8ORADn9VksMpsZMZeewncHD11PCEijvBQfIiSyHdkM0DSu7yMsttdeD3wf7aimhHXaTuEGhDSwc8a11j1hun6l2g4p0fUHKXvM23ruCFMvWk3qiLo9b5ATO6Lc9tWAVXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"UITextView bug\"\n        title=\"\"\n        src=\"/static/3ea8ca711570d31702b6e5b47ccb2534/fcda8/UITextView-bug.png\"\n        srcset=\"/static/3ea8ca711570d31702b6e5b47ccb2534/12f09/UITextView-bug.png 148w,\n/static/3ea8ca711570d31702b6e5b47ccb2534/e4a3f/UITextView-bug.png 295w,\n/static/3ea8ca711570d31702b6e5b47ccb2534/fcda8/UITextView-bug.png 590w,\n/static/3ea8ca711570d31702b6e5b47ccb2534/7762d/UITextView-bug.png 649w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>This is defenetly not what we want. It turns out that to fix that we need to disable scrolling and editing in our text view.<br>\nNow everything should work as expected and you should see something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/074218e6b422cd2ac8746133dc20e3c1/8ce52/TextView.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABm0lEQVR42u2Tz0tUURTHB9y4MBMUQhSH8B8QctE6+ivaZAmiW0vQUXHUcCGmBLUw3AUmCmU4lMiouG2j4zgz9mMTmrnTe3lz35u5d+YT9+nEe5GIS6EDXw73nPP93LM5EcdxMMagtUbrIkaXOPC22S0ukykmyOgVUuo9Kde+V8joBCnvHQfejj9rPdZrGfl8nojneZxFmUp8UE9JHE6yfjhH8ucsm7/OcvLoNWs/ZkmevOBjcfDPfPnca1mRQqHwF7DMqnrG5+wWuVyW9H6K3LcsmS9p9r9nSe/t8fV4mw09GdjhAmDlpwXVyYRqZca9w3O3jSnV5merGbedcec2S6o74LoEOK8e0ndazbC4xZBoCMnW+kQ1i27XVYAdDIhaRmULcdkU0phs8XuL6orAfnGDuGxmRDaGNCqb6Rc1/4HXHrigHhMTdYzJqA8IalxGiYmbLKmewNkFgMFbrgDfqAc8EVUMyXpisi4kW+sVVbxVj/69oVKKUqmEMRptNGUDCWeQ6dO7vBL3eSnuhWRrtvfJiYPB91ivZVjWbwQg9QBFgCs8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TextView\"\n        title=\"\"\n        src=\"/static/074218e6b422cd2ac8746133dc20e3c1/fcda8/TextView.png\"\n        srcset=\"/static/074218e6b422cd2ac8746133dc20e3c1/12f09/TextView.png 148w,\n/static/074218e6b422cd2ac8746133dc20e3c1/e4a3f/TextView.png 295w,\n/static/074218e6b422cd2ac8746133dc20e3c1/fcda8/TextView.png 590w,\n/static/074218e6b422cd2ac8746133dc20e3c1/8ce52/TextView.png 681w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h4>Handling taps</h4>\n<p>Next we want our text view to switch it's state to full mode if we tap on \"Read more\" text. To do that we can check the point we tapped in <code>hitTest</code> function and reset to full mode if we need.</p>\n<p>We need a function that will check if point is in range of <code>trimText</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">var</span> trimTextRangePadding<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIEdgeInsets</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">UIEdgeInsetsZero</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">pointInTrimTextRange</span><span class=\"token punctuation\">(</span>point<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGPoint</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Bool</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> offset <span class=\"token operator\">=</span> <span class=\"token class-name\">CGPointMake</span><span class=\"token punctuation\">(</span>textContainerInset<span class=\"token punctuation\">.</span><span class=\"token keyword\">left</span><span class=\"token punctuation\">,</span> textContainerInset<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> boundingRect <span class=\"token operator\">=</span> layoutManager<span class=\"token punctuation\">.</span><span class=\"token function\">boundingRectForCharacterRange</span><span class=\"token punctuation\">(</span><span class=\"token function\">trimTextRange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> inTextContainer<span class=\"token punctuation\">:</span> textContainer<span class=\"token punctuation\">,</span> textContainerOffset<span class=\"token punctuation\">:</span> offset<span class=\"token punctuation\">)</span>\n    boundingRect <span class=\"token operator\">=</span> <span class=\"token class-name\">CGRectOffset</span><span class=\"token punctuation\">(</span>boundingRect<span class=\"token punctuation\">,</span> textContainerInset<span class=\"token punctuation\">.</span><span class=\"token keyword\">left</span><span class=\"token punctuation\">,</span> textContainerInset<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">)</span>\n    boundingRect <span class=\"token operator\">=</span> <span class=\"token class-name\">CGRectInset</span><span class=\"token punctuation\">(</span>boundingRect<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token punctuation\">(</span>trimTextRangePadding<span class=\"token punctuation\">.</span><span class=\"token keyword\">left</span> <span class=\"token operator\">+</span> trimTextRangePadding<span class=\"token punctuation\">.</span><span class=\"token keyword\">right</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token punctuation\">(</span>trimTextRangePadding<span class=\"token punctuation\">.</span>top <span class=\"token operator\">+</span> trimTextRangePadding<span class=\"token punctuation\">.</span>bottom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">CGRectContainsPoint</span><span class=\"token punctuation\">(</span>boundingRect<span class=\"token punctuation\">,</span> point<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we use a new property to define padding around <code>trimText</code> bounding rect in which we will handle taps.</p>\n<p>Now we can implement our <code>hitTest</code> function:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">touchesEnded</span><span class=\"token punctuation\">(</span>touches<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Set</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">UITouch</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> withEvent event<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIEvent</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> point <span class=\"token operator\">=</span> touches<span class=\"token punctuation\">.</span>first<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">locationInView</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token function\">needsTrim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">pointInTrimTextRange</span><span class=\"token punctuation\">(</span>point<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        maximumNumberOfLines <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        shouldTrim <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Note: originally I've made a mistake doing that in <code>hitTest</code> method. The thing is that this method may be called by the system several times during handling of a single touch event. Thus this method should not have any side effects.</p>\n</blockquote>\n<h4>Interface Builder</h4>\n<p>This is the easiest part 'cause all we need to make our component to update in Interface Builder and to set it's properties in Attributes Inspector is to add @IBDesignable and @IBInspectable directives. We don't need to define <code>prepareForInterfaceBuilder</code> 'cause when we change <code>maximumNumberOfLines</code> or other properties we make layout update.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@IBDesignable</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ReadMoreTextView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UITextView</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token attribute atrule\">@IBInspectable</span>\n    <span class=\"token keyword\">var</span> maximumNumberOfLines<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n    <span class=\"token attribute atrule\">@IBInspectable</span>\n    <span class=\"token keyword\">var</span> trimText<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSString</span><span class=\"token operator\">?</span>\n\n    <span class=\"token attribute atrule\">@IBInspectable</span>\n    <span class=\"token keyword\">var</span> shouldTrim<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Conclusion</h4>\n<p>We have developed custom text view in Swift and we used TextKit functionality for that. You can easily extend this component to add for example attributed trim text property so user can customize it's appearance. Also you might see how it's possible to develop components just in playgrounds. After you finished you can move all the code of your component in separate source file and import it to your project. Thought playgrounds lack interactivity (i.e. you can not recieve touch events from Assistant Editor) and some times don't update fast still lots of things could be done just in playgrounds with no need to create and setup whole new project.</p>\n<p>Source code for this article is available on <a href=\"https://github.com/ilyapuchka/ReadMoreTextView\">github</a>.</p>","fields":{"slug":"/custom-uitextview-in-swift/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f60","title":"Custom UITextView in Swift","date":"April 04, 2015","description":"In this article I want to describe how I developed custom UITextView component in Swift using TextKit, Playgrounds and IBDesignable and IBInspectable directives.","tags":"iOS"}},"previous":{"excerpt":"Probably lately you've seen few posts on this subject like this or that. Both of described techiques share the same secret - how playground is run in Simulator…","fields":{"slug":"/quick-overview-of-swift-playgrounds-in-ios-simulator/"},"frontmatter":{"title":"Quick overview of Swift Playgrounds in iOS Simulator","date":"March 16, 2015"}},"next":{"excerpt":"or What Swift Language Guide do not tell you. This post contains the list of interesting features of Swift that I find while using it. To make it more…","fields":{"slug":"/swift-interesting-features/"},"frontmatter":{"title":"Swift interesting features","date":"April 19, 2015"}}},"pageContext":{"id":"ed4c5872-112e-562b-9154-9d9acb635f77","previousPostId":"e66628d2-b980-5088-8c7e-87a95c18b2d7","nextPostId":"b68e0bb1-3ce5-534f-a0b9-d6b6aa330ac2"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}