{"componentChunkName":"component---src-templates-blog-post-js","path":"/parametrised-jobs-in-circleci/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"47867239-5f75-5589-a5e4-db9f0b9ca752","excerpt":"The title is a lie - there is no such thing as parameterized jobs (at the time of writing, but seems it’s going to be improved in 2.1) when we are talking about…","html":"<p>The title is a lie - there is no such thing as parameterized jobs (at the time of writing, but seems it’s going to be improved in <a href=\"https://github.com/CircleCI-Public/config-preview-sdk/blob/master/docs/whats-new.md\">2.1</a>) when we are talking about CircleCI 2.0 workflows, which are (almost) awesome by the way. But with some tricks, we can achieve something close to that.</p>\n<p>Here is the problem. Let's say we have a bunch of jobs which are exactly the same except what build or test command they invoke in the end. They all need to perform the same sequence of actions:</p>\n<ul>\n<li>checkout code</li>\n<li>install dependencies (different Homebrew packages, Ruby gems, CocoaPods and/or Carthage dependencies)</li>\n<li>cache all of that so that future jobs don't spend more time than needed downloading everything all over again</li>\n<li>run some build or test command, i.e. execute some lane or rake task</li>\n<li>save artifacts and test results</li>\n</ul>\n<p>That's a lot of boilerplate. How do we avoid repeating it and yet have different jobs for different tasks?</p>\n<p>CircleCI 2.0 offers different ways to simplify such configuration, which are very well described in its documentation: we can use cache to store dependencies based on lock-file checksums, and we can use workflows to break all these steps into separate jobs and use workspaces to share data between them.</p>\n<p>Unfortunately, I found that using workspaces adds significant overhead to the total time of the workflow (it was about 8 minutes in my case, which is pretty close to 50% of total workflow time without workspaces). If we extract checkout and dependencies installation steps into a separate job then we'll need to persist into the workspace all the content in the working directory. And yes, it will also persist whole <code>.git</code> folder. This adds several minutes to archive and then unarchive in the next job. Additionally, we might need to store Derived Data to use <code>build-for-testing</code> and <code>test-without-building</code> features of <code>xcodebuild</code> to pass it between build and test jobs. This adds time again. So even though now we have a nice pipeline where we first checkout, then build, then execute tests in parallel, such workflow can become much longer to run. And it does not give apparent performance improvements compared with a workflow that simply performs all the same steps for each of the jobs in parallel.</p>\n<p>For that reason, I had to opt out using workspaces and had to repeat all of the steps in each job...</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">regression_test_bupa:\n    &lt;&lt;: *container_config\n\n    steps:\n        - checkout\n        - *lfs\n        - *brew\n        - *restore_gems_cache\n        - *bundle_install\n        - *save_gems_cache\n        - *restore_cocoapods_cache\n        - *pod_install\n        - *save_cocoapods_cache\n        - *restore_carthage_cache\n\n        - run:\n            name: Fastlane\n            no_output_timeout: 60m\n            command: bundle exec fastlane regression_test_bupa\n\n        - *store_fastlane_output\n        - *store_scan_results\n        - *store_snapshot_diffs</code></pre></div>\n<p>There is a YAML feature that I use here to avoid even more repetitions - aliases. This way I extract configurations common for each job:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- &amp;container_config\n    macos:\n        xcode: \"9.4.1\"\n    working_directory: /Users/distiller/project\n    shell: /bin/bash --login -eo pipefail\n    environment:\n        LC_ALL: en_US.UTF-8\n        LANG: en_US.UTF-8\n        SCAN_DEVICE: iPhone 5s\n        FL_OUTPUT_DIR: output\n        FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 10</code></pre></div>\n<p>or individual steps, i.e. installing CocoaPods:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- &amp;cocoapods_cache_key\n    2-pods-{{ checksum \"Podfile.lock\" }}\n\n- &amp;restore_cocoapods_cache\n    restore_cache:\n        key: *cocoapods_cache_key\n\n- &amp;pod_install\n    run:\n        name: Pod Install\n        command: |\n            bundle exec pod --version\n            diff Podfile.lock Pods/Manifest.lock || curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf\n            bundle exec pod install\n\n- &amp;save_cocoapods_cache\n    save_cache:\n        key: *cocoapods_cache_key\n        paths:\n            - Pods\n            - ~/.cocoapods/repos</code></pre></div>\n<p>But YAML aliases don't support arrays, so can't be used to reuse steps definition between jobs.</p>\n<p>It was fine in the beginning but when I started to move other jobs from Jenkins to CircleCI, config file grew immensely. Turns out that I already knew the solution for that, just didn't see it. There is the answer to that problem <a href=\"https://discuss.circleci.com/t/parameterized-jobs-within-workflows/16662/2\">here</a> but it does not go into details. So here we go.</p>\n<p>As I mentioned before YAML aliases support only key-value pairs, not collections. So then we can extract <code>steps</code> key-value pair into an alias that we can then include in each job.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- &amp;fastlane\n    run:\n        name: Fastlane\n        no_output_timeout: 60m\n        command: bundle exec fastlane ???\n\n- &amp;base_steps\n    steps:\n        - checkout\n        - *lfs\n        - *brew\n        - *restore_gems_cache\n        - *bundle_install\n        - *save_gems_cache\n        - *restore_cocoapods_cache\n        - *pod_install\n        - *save_cocoapods_cache\n        - *restore_carthage_cache\n\n        - *fastlane\n\n        - *store_fastlane_output\n        - *store_scan_results\n        - *store_snapshot_diffs</code></pre></div>\n<p>But that does not allow us to override individual steps, like <code>fastlane</code> step here, so that we can perform different build or test commands in different jobs. We can only override all steps or none of them.</p>\n<p>But we can use environment variables as parameters for these commands. Using Fastlane (or Rakefile, or Makefile) simplifies that a lot because we only need to set an environment variable with a name of a lane or rake task. And we might not even need it because we can use job name already exposed as environment variable out of the box.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- &amp;fastlane\n    run:\n        name: Fastlane\n        no_output_timeout: 60m\n        command: bundle exec fastlane ${LANE:-$CIRCLE_JOB}</code></pre></div>\n<p>To be able to override/add environment variables we also need to extract <code>environment</code> key-value pair into an alias:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- &amp;env_defaults\n    LC_ALL: en_US.UTF-8\n    LANG: en_US.UTF-8\n    SCAN_DEVICE: iPhone 5s\n    FL_OUTPUT_DIR: output\n    FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 10\n\n- &amp;container_config\n    macos:\n        xcode: \"9.4.1\"\n    working_directory: /Users/distiller/project\n    shell: /bin/bash --login -eo pipefail\n    environment:\n        &lt;&lt;: *env_defaults</code></pre></div>\n<p>And now to define a \"parametrized\" job we need just a few lines:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">jobs:\n    build_bupa_for_distribution:\n        &lt;&lt;: *container_config\n        &lt;&lt;: *base_steps\n\n    test_bupa:\n        &lt;&lt;: *container_config\n        &lt;&lt;: *base_steps\n\n    regression_test_bupa:\n        &lt;&lt;: *container_config\n        environment:\n            &lt;&lt;: *env_defaults\n            SCAN_DEVICE: iPhone 8 Plus (11.4)\n        &lt;&lt;: *base_steps</code></pre></div>\n<p>Each of these jobs will perform exactly the same steps before invoking specific lane, defined by the name of the job and using default environment variables. If needed we can override lane name setting <code>LANE</code> environment variable. And for UI tests we can also override the type of simulator device to run them on (I couldn't make it work with <code>SCAN_DEVICES</code> though).</p>\n<p>As a result, config file became around 2 times smaller - from initial 700 lines it went to just 370.</p>\n<p>This way we can parametrize any number of steps, or even skip some steps (out of the box workflows only can skip whole jobs, not individual steps, and only based on a branch or a tag name). And extracting steps into Fast/Rake/Make-file will not only make this task simpler but will also help to keep config file clean.</p>","fields":{"slug":"/parametrised-jobs-in-circleci/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f89","title":"Parameterized jobs in CircleCI","date":"August 07, 2018","description":"The title is a lie - there is no such thing as parameterized jobs (at the time of writing, but seems it’s going to be improved in 2.1) when we are talking about CircleCI 2.0 workflows, which are (almost) awesome by the way. But with some tricks, we can achieve something close to that.","tags":""}},"previous":{"excerpt":"One of the first tasks I got in my new team was to convert entire code base from in-house JSON encoding/decoding solution (in fact two of them) to Swift native…","fields":{"slug":"/codable-in-practice/"},"frontmatter":{"title":"Codable in practice","date":"May 05, 2018"}},"next":{"excerpt":"This article is based on the talk I gave at iOS Astronauts meetup that was held on 03.10.2018 at Babylon. You can check out this talk and other videos as well…","fields":{"slug":"/ios-ui-automation-tests-at-babylon/"},"frontmatter":{"title":"iOS UI Automation Tests at Babylon","date":"October 08, 2018"}}},"pageContext":{"id":"47867239-5f75-5589-a5e4-db9f0b9ca752","previousPostId":"dbfdbebf-cd01-59b1-8cf8-349b6080a9b5","nextPostId":"45470497-e3bd-5418-8391-6664ce5dcb2e"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}