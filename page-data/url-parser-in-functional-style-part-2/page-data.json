{"componentChunkName":"component---src-templates-blog-post-js","path":"/url-parser-in-functional-style-part-2/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"d1a09427-7e5b-55a4-a1da-506f7e136ef6","excerpt":"In previous part we started to write base components of URL parser. Time to extend it and add some additional functionality, like conditional, optional andâ€¦","html":"<p><a href=\"http://ilya.puchka.me/url-parser-in-swift-functional-style-part-1/\">In previous part</a> we started to write base components of URL parser. Time to extend it and add some additional functionality, like conditional, optional and wildcard patterns.</p>\n<h4>Conditional pattern</h4>\n<p>This pattern should parse either one pattern or another. This kind of parameter type can be expressed with <code>Either&#x3C;A, B></code> type defined as a simple generic enum with two cases.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">Either</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">right</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Using this type we can compose parser and printer. Parser will try to parse left pattern first and return matched value wrapped in <code>Either.left</code>, otherwise it will parse right pattern and return matched value wrapped in <code>Either.right</code>. Printer will pattern match this value and will print left or right pattern.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">parseEither</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Parser</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Either</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        lhs<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>rest<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Either</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">??</span> rhs<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>rest<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Either</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">right</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">printEither</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Printer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Either</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">L</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token short-argument\">$0</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> lhs<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">right</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> rhs<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">templateOr</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"(</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">lhs<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">|</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">rhs<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With that we can now define operator for this kind of composition.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">|&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Either</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseEither</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printEither</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateOr</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For <code>Void</code> types we need again to handle composition separately, but we only need to handle one case when <code>Void</code> is on both sides. In case if <code>Void</code> is on one side we will have <code>Either&#x3C;Void, A></code> or <code>Either&#x3C;A, Void></code> type in which we can not easily get rid of <code>Void</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">parseAny</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Parser</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> lhs<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> rhs<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">printAny</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Printer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> lhs<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> rhs<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">A</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Path</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">|</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseAny</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printAny</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateOr</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With that we can define more complex patterns like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> profileRoute <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> <span class=\"token punctuation\">(</span>string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"profile\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"me\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://users/username/profile\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> profileRoute<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), .left(\"username\"))</span>\n\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://users/me\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> profileRoute<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), .right(()))</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> profileRoute<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"username\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"username\", \"profile\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> profileRoute<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">right</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"me\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> profileRoute<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \"users/(:string/profile|me)\"</span></code></pre></div>\n<p>In this case we define pattern for <code>Either&#x3C;String, Void></code>, but for this kind of cases it might be better to use optional pattern.</p>\n<h4>Optional pattern</h4>\n<p>This pattern should succeed parsing and printing even if it actually failed. For that type of pattern parameter should be <code>A?</code>. We will create this pattern with a simple function that will wrap another patter with parameter type <code>A</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">maybe</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> url <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> route<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token nil constant\">nil</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>rest<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span>print<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"(</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">route<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note that in parser we can not just return <code>result</code>, as its type will be <code>(RouteComponents, A)</code> but we need to return <code>(RouteComponents, A?)</code>, so we have to deconstruct and construct tuple again.</p>\n<p><code>Void</code> parameter type again requires special attention. It does not make much sense to have pattern with <code>Void?</code> parameter type, we can just keep <code>Void</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">maybe</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> route<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> <span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> route<span class=\"token punctuation\">.</span>print<span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"(</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">route<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With that we can define patterns composition:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">infix</span> <span class=\"token keyword\">operator</span> <span class=\"token operator\">/?</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">MultiplicationPrecedence</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Path</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/?</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">maybe</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseLeft</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printLeft</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/?</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">maybe</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/?&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">maybe</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With this operator we hide wrapping of right pattern in a <code>maybe</code> function and make its usage more natural. Similar operators we can define for query patterns:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">infix</span> <span class=\"token keyword\">operator</span> <span class=\"token operator\">.??</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">MultiplicationPrecedence</span>\n<span class=\"token keyword\">infix</span> <span class=\"token keyword\">operator</span> <span class=\"token operator\">&amp;?</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">MultiplicationPrecedence</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Query</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">.??</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">maybe</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">.??&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">A</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">maybe</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">&amp;?&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">maybe</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Wildcard pattern</h4>\n<p>This pattern will be the most complicated. First we need to introduce two more state of a pattern: one that marks that subsequent pattern is required - <code>AnyStart</code> and one that marks that pattern ends with any path - <code>AnyEnd</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">protocol</span> <span class=\"token class-name\">AnyPattern</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">AnyStart</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyPattern</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">OpenPatternState</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">AnyEnd</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyPattern</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClosedPathPatternState</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Lets start with Wildcard pattern used in the end of the path.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">let</span> any<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyEnd</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> route <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">guard</span> route<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>first <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token omit keyword\">_</span> <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"*\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"*\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Type of the pattern is <code>RoutePattern&#x3C;Void, AnyEnd></code> because we are not going to extract any parameters from it and we should not allow any other path patterns after it, so it's status should be \"closed\" but different from <code>Path</code>.<br>\nTo parse it we just check if there are any paths left. If there is none we fail (wildcard pattern requires at least one more path component), otherwise we drop all the components left in the path and only keep query.</p>\n<p>We can now define composition for route with wildcard pattern, nothing special here:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Path</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// string /> any</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyEnd</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyEnd</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// param >/> any</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">>/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyEnd</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyEnd</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseLeft</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printLeft</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the case when wildcard used before other pattern we will define a function that accepts next pattern. As wildcard means that there can be any kind of path components before next pattern we will simply try to match next pattern until it succeeds. If it fails we will drop path component and try again until it matches or we reach the end of the path.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">any</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> next<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyStart</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> route <span class=\"token keyword\">in</span>\n        <span class=\"token comment\">// there should be at least one path component before `next`, so we drop it from the beginning</span>\n        <span class=\"token keyword\">for</span> index <span class=\"token keyword\">in</span> route<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>indices <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// try match the rest of pattern with the rest of path</span>\n            <span class=\"token keyword\">let</span> rest <span class=\"token operator\">=</span> route<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">suffix</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">:</span> index<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> nextResult <span class=\"token operator\">=</span> next<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>rest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> nextResult\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> nextResult <span class=\"token operator\">=</span> next<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"*\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> nextResult<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"*/</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">next<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>First we define composition when wildcard is used at start of path as it's the simplest case:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Path</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// any /> something</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyStart</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> route <span class=\"token operator\">=</span> <span class=\"token function\">lhs</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> route<span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> route<span class=\"token punctuation\">.</span>print<span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> route<span class=\"token punctuation\">.</span>template<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This pattern accepts <code>any</code> pattern as first parameter and right pattern. Note that though <code>lhs</code> parameter type is a closure it has the same signature as <code>func any&#x3C;A>(_ next: RoutePattern&#x3C;A, Path>) -> RoutePattern&#x3C;A, AnyStart></code>, so it means that we can pass <code>any</code> function to it. Then we pass right pattern to this function so that we get a pattern that will match it. But as it has <code>AnyStart</code> state but we need tor return pattern with <code>Path</code> state we construct a new pattern.</p>\n<p>Now we can define patterns with wildcard pattern at start and end of path:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> anyStart <span class=\"token operator\">=</span> any <span class=\"token operator\">/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> anyEnd <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> any\n\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://something/users\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> anyStart<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), ())</span>\n\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://users/something\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> anyEnd<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>routeComponents<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = ((path: [], query: [:]), ())</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> anyStart<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"*\", \"users\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> anyEnd<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"*\"], query: [:])</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> anyStart<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \"*/users\"</span>\n\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> anyEnd<span class=\"token punctuation\">.</span>template\n<span class=\"token comment\">// template = \"users/*\"</span></code></pre></div>\n<p>For the most complicated case when wildcard is used in the middle of the path we will need a small helper that will be able to \"consume\" the subsequent pattern to produce a new pattern:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">AwaitingPattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">LeftType</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RightType</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ResultType</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> consume<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">RightType</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">ResultType</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For composition we need to define two operators:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Path</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// param >/> any (>/> param)</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">>/>&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyStart</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">AwaitingPattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">rhs</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printBoth</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// (param >/> any) >/> param</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">>/>&lt;</span><span class=\"token class-name\">B</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AwaitingPattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> lhs<span class=\"token punctuation\">.</span><span class=\"token function\">consume</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>First function accepts left pattern with parameter of type <code>A</code> and <code>any</code> function that expects next pattern with parameter type <code>B</code>. This function returns <code>AwaitingPattern</code>. It has left type of <code>A</code>, right type of <code>B</code> and the result type of <code>(A, B)</code> as it will be actual pattern result after all the components are concatenated.</p>\n<p>Second function accepts <code>AwaitingPattern</code> that we got from first function and a pattern with parameter type <code>B</code>. As a result it produces composed pattern of type <code>(A, B)</code>. This way we actually concatenate three patterns, one of the left side, wildcard itself, and one on the right side.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> anyMiddle<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> int <span class=\"token operator\">>/></span> any <span class=\"token operator\">>/></span> string</code></pre></div>\n<p>We have to handle <code>Void</code> types separately again, for both cases - <code>Void</code> on the left and <code>Void</code> on the right:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">S</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Path</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// string /> any (/> param)</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyStart</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">AwaitingPattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">A</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">rhs</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printRight</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// (string />) any /> param</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AwaitingPattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> lhs<span class=\"token punctuation\">.</span><span class=\"token function\">consume</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// param >/> any (>/> string)</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">>/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AnyStart</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">AwaitingPattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">A</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> rhs <span class=\"token operator\">=</span> <span class=\"token function\">rhs</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token function\">parseLeft</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token function\">printLeft</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> <span class=\"token function\">templateAnd</span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// (param >/>) any >/> string</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token operator\">>/></span><span class=\"token punctuation\">(</span>lhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AwaitingPattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> rhs<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> lhs<span class=\"token punctuation\">.</span><span class=\"token function\">consume</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In case we have <code>Void</code> on the left the resulting type of pattern parameter will be type of right pattern. In case we have <code>Void</code> on the right - it will be type of left pattern. Implementations are trivial in both cases, we just need to get types right.</p>\n<h4>Router</h4>\n<p>The last component of the puzzle is a router, object that holds mapping between routes and patterns and uses it match URLs or print URLs for routes. To hold this map we could use array or dictionary, but instead we will reuse <code>RoutePattern</code> and its composition. When first pattern will be registered for some route we will store a reference to it. When new pattern is added we will compose it with current pattern in a way similar to how we composed pattern for <code>Either</code>. This is similar to how you can replace loop with recursion.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Router</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">U</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Route</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">U</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">>?</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">U</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>route <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> oldValue <span class=\"token keyword\">in</span>\n            <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> oldValue<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> route<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    print<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> oldValue<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> route<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    template<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">oldValue<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\\n</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">route<span class=\"token punctuation\">.</span>template</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> route\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">self</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>One important thing to note here is generic type of <code>Router</code>. It should conform to special protocol <code>Route</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">protocol</span> <span class=\"token class-name\">Route</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Equatable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">deconstruct</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> constructor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">Self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">A</span><span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It requires only one function that accepts some generic \"constructor\" that converts generic type <code>A</code> to <code>Self</code> and returns this generic parameter back. You'll see why it's needed and hot it is used in a minute.</p>\n<p>So we have now <code>RoutePattern&#x3C;U, Path></code> that we can use for matching. <code>U</code> here stands for the type of the route (or intent) that we defined in the beginning of first part:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">Route</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> showMyProfile\n    <span class=\"token keyword\">case</span> <span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">follow</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">retweet</span><span class=\"token punctuation\">(</span>tweetId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">showUserTweet</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> tweetId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let's define some possible patterns for these routes:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> showMyProfile<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"me\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> showProfile<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"profile\"</span></span><span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">let</span> follow<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"follow\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> retweet<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Query</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span>retweet<span class=\"token punctuation\">)</span> <span class=\"token operator\">.?</span> <span class=\"token function\">int</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"tweetId\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> showUserTweet<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Path</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"tweets\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>/></span> int</code></pre></div>\n<p>As you can see generic types of these patterns do not match type <code>U</code> which our router expects. So how do we actually register them?</p>\n<p>For that we need to \"map\" patterns over their parameter type. But this should be a special kind of map, that can do transformation on both directions. We need that to be able to map tuple of associated values to enum case and convert enum case back to tuple of its associated values. We do that using already familiar <code>apply</code> and <code>unapply</code> functions.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">RoutePattern</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">map</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> apply<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">B</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> unapply<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">A</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>parse<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> value <span class=\"token operator\">=</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>rest<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> print<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> value <span class=\"token operator\">=</span> <span class=\"token function\">unapply</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">:</span> template<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So to map pattern of type <code>A</code> to pattern of type <code>B</code> we need functions that can convert <code>A</code> to <code>B</code> and <code>B</code> to <code>A</code>. Their result types are optional as we allow this transformations to fail so that we can fail parsing or printing.</p>\n<p>Let's now use this function to register a simplest pattern:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token attribute atrule\">@discardableResult</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPatternState</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> intent<span class=\"token punctuation\">:</span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> intent <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span> <span class=\"token operator\">==</span> intent <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we are using <code>map</code> to create a new pattern that will convert <code>Void</code> to <code>U</code>, for which we just need to return value of <code>U</code> that we got as input parameter. For printing we need to check that parameter sent to print, <code>U</code> is equal to intent that we are registering this pattern for.</p>\n<p>Here is how we use it:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> router <span class=\"token operator\">=</span> <span class=\"token class-name\">Router</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Routes</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span>showMyProfile<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"me\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appscheme://users/me\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n\n<span class=\"token keyword\">let</span> parsed <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>components<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// parsed = Routes.showMyProfile</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span>showMyProfile<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"me\"], query: [:])</span></code></pre></div>\n<p>Let's now try to register route with one parameter:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token attribute atrule\">@discardableResult</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPatternState</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> intent<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token function\">intent</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">???</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The input parameter of this function is a function that accepts parameter <code>A</code> and returns <code>U</code>. For that we can use enum cases constructor. I.e. <code>Routes.showProfile</code> has type of <code>(String) -> Routes</code>, <code>Routes.showUserTweet</code> has type of <code>(String, Int) -> Routes</code>. So to map <code>A</code> to <code>U</code> we just need to pass <code>A</code> to this constructor to get <code>U</code>.</p>\n<p>But how do we get <code>A</code> from value of <code>U</code>. Essentially it will mean that we need to extract associated values from value of enum. In Swift we usually do that with <code>if case let</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">if</span> <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> value <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>But we can't use this inside <code>unapply</code> closure, because we don't know to what case to match the value, we only get it's constructor. We can't write something like <code>if case intent = value</code>, it just does not make sense. So how do we solve that? That's where our <code>deconstruct</code> function comes in. It accepts <code>(A) -> Self</code> as parameter. That's exactly the signature of our input <code>intent</code> parameter, so the only thing we can do is to pass it in. As a result we will get <code>A?</code>, that's exactly what we need to return from unapply function, so everything matches!</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token attribute atrule\">@discardableResult</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPatternState</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> intent<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token function\">intent</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token function\">deconstruct</span><span class=\"token punctuation\">(</span>intent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now let's see how we can implement this function:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">Routes</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Route</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">deconstruct</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> constructor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Routes</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">A</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">???</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The point of this method is to extract associated values from enum value in case it matches the constructor. So first we extract values from each case:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">switch</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">follow</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">retweet</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showUserTweet</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>What we can do now with these extracted associated values. We can try to simply return them, but we can't as their type does not match generic parameter <code>A</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">switch</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values <span class=\"token comment\">// error: Cannot convert return expression of type 'String' to return type 'A?'</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To solve that we should use less known feature of pattern matching - matching by type:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">switch</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>values <span class=\"token keyword\">as</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">follow</span><span class=\"token punctuation\">(</span>values <span class=\"token keyword\">as</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">retweet</span><span class=\"token punctuation\">(</span>values <span class=\"token keyword\">as</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showUserTweet</span><span class=\"token punctuation\">(</span>values <span class=\"token keyword\">as</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This way we only match cases if type of <code>A</code> matches type of case associated values. Otherwise we sink to default case which returns <code>nil</code>.</p>\n<p>Now everything compiles, but let's think what will happen if we just return associated values like we do now. Let's assume that we registered route <code>showProfile(userId: String)</code> in our router:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\">router<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span>showProfile<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"profile\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Let's now try to print url for it.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\">router<span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span><span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"username\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This will result in call <code>Routes.showProfile(userId: \"username\").deconstruct(Routes.showProfile)</code> which will return <code>\"username\"</code>, as expected. But what if instead we pass in value of <code>Routes.follow(\"username\")</code>?</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\">router<span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span><span class=\"token function\">follow</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"username\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In this case it will call <code>Routes.follow(\"username\").deconstruct(Routes.showProfile)</code>. And as the only thing that we are doing is pattern matching we will again return <code>\"username\"</code>, though we should return <code>nil</code> instead as this route was never registered. It means that we need to do something more than just pattern matching - we need to check if the value created by constructor passed to <code>deconstruct</code> is actually the same value on which this method was called. In case they don't match we should return <code>nil</code> as printing should fail, in case they match we return extracted associated value.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">switch</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>values <span class=\"token keyword\">as</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token keyword\">self</span> <span class=\"token operator\">==</span> <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">follow</span><span class=\"token punctuation\">(</span>values <span class=\"token keyword\">as</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token keyword\">self</span> <span class=\"token operator\">==</span> <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">retweet</span><span class=\"token punctuation\">(</span>values <span class=\"token keyword\">as</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token keyword\">self</span> <span class=\"token operator\">==</span> <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values\n    <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> <span class=\"token punctuation\">.</span><span class=\"token function\">showUserTweet</span><span class=\"token punctuation\">(</span>values <span class=\"token keyword\">as</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token keyword\">self</span> <span class=\"token operator\">==</span> <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> values\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token nil constant\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Note: as you can see we only define this method on the cases <em>with</em> associated values, because for cases without associated values we need <code>A</code> to be <code>Void</code>, but there is no way to express it in Swift, and we will just use <code>==</code> operator in this case.</p>\n</blockquote>\n<p>Now we not only make sure that type of associated values match <code>A</code>, but also that enum value created by constructor matches the value that we called <code>deconstruct</code> method on. Which means that we will only get associated values if we pass in to <code>print</code> the same enum value that we passed in to <code>add</code> method:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\">router<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span>showProfile<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"profile\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span><span class=\"token function\">showProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"username\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"username\", \"profile\"], query: [:])</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span>follow<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"users\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/></span> string <span class=\"token operator\">>/></span> <span class=\"token function\">lit</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"follow\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> printed <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Routes</span><span class=\"token punctuation\">.</span><span class=\"token function\">follow</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"username\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// printed = (path: [\"users\", \"username\", \"follow\"], query: [:])</span></code></pre></div>\n<p>Cool! Almost there!</p>\n<p>Now let's see how do we register route with two parameters:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token attribute atrule\">@discardableResult</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPatternState</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> intent<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token function\">intent</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token function\">deconstruct</span><span class=\"token punctuation\">(</span>intent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Exactly the same, except our parameter type is now <code>(A, B)</code>. What about three parameters?</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPatternState</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> intent<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token function\">intent</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token function\">deconstruct</span><span class=\"token punctuation\">(</span>intent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This will not compile as we have a mismatch between type of enum constructor input values <code>(A, B, C)</code> and type of pattern parameter <code>((A, B), C)</code>. To solve that we need to define functions which will convert these types from one to another:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">flatten</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> t<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">parenthesize</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> t<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>flatten</code> method gets \"grouped\" tuple value and flattens it to a plane tuple. <code>parenthesize</code> do the opposite, it takes \"flat\" tuple and groups it's element in tuples of two elements. Now we can use these functions to make compiler happy:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token attribute atrule\">@discardableResult</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClosedPatternState</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> intent<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RoutePattern</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">A</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Router</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token function\">intent</span><span class=\"token punctuation\">(</span><span class=\"token function\">flatten</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token function\">deconstruct</span><span class=\"token punctuation\">(</span>intent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>parenthesize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we just need to define these methods for 4, 5 and 6 parameters (that should be enough for most cases). And we are done.</p>\n<p>Phew! That was <strong>a lot</strong> of code! <strong>A lot</strong> of small functions! But it's very satisfying that it works in the end! Let's summarise what we have now.</p>\n<h4>Conclusion</h4>\n<p>The main question: is this implementation better than imperative? As always there are some profits and some drawbacks.</p>\n<p>Pros:</p>\n<ul>\n<li>\n<p>parsing became way much simpler, especially when it comes to implementing complex patterns like wildcard. It's built with very small functions which are easy to understand and test, and their composition</p>\n</li>\n<li>\n<p>it's much more type-safe, parameters can be extracted into associated values automatically (almost) instead of aggregating them in weakly typed dictionary where all values are strings and we need to manually convert their types and pass them in enum case constructor</p>\n</li>\n<li>\n<p>we got printing almost for free</p>\n</li>\n</ul>\n<p>Cons:</p>\n<ul>\n<li>\n<p>we had to use few custom operators instead of one standard (<code>/</code>). I already mentioned a reason for that in the first part - using one operator will produce too many overloads of it and Swift will not be able to compile such expressions. Even with two custom operators compilation sometimes takes more time comparing with if we would use third, <code>>/</code> operator. Hopefully this will be possible to solve with conditional protocol conformance</p>\n</li>\n<li>\n<p>as you saw we need to write some boilerplate to get things together for printing URLs. If we don't need printing we can remove it, which will make implementation much easier: we only will need <code>apply</code> functions and we will not need <code>print</code> functions at all</p>\n</li>\n<li>\n<p>parsing is now based on recursion which can be a bit hard to wrap your head around at first. It can also come with some performance and memory overhead as we are composing functions, but I didn't perform any measurements yet</p>\n</li>\n</ul>\n<p>In the end I'm personally not sure about how much I'm satisfied with results. The main disadvantage for me is use of several custom operators. It's very satisfactory though that I managed to understand how to do it and learned few things along the way about composition and phantom types. Thanks to <a href=\"https://twitter.com/mbrandonw\">Brandon Williams</a> again for sharing his code and making this learning opportunity possible!</p>\n<p>You can find all the code on <a href=\"https://github.com/ilyapuchka/Deeper/pull/5\">github</a>.</p>","fields":{"slug":"/url-parser-in-functional-style-part-2/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f87","title":"URL parser in functional style. Part 2.","date":"November 07, 2017","description":"In previous part we started to write base components of URL parser. Time to extend it and add some additional functionality, like conditional, optional and wildcard patterns.","tags":""}},"previous":{"excerpt":"When I published one of my previous posts about deeplinks and then decided to turn it into a framework it turned out that Brandon Williams was working on aâ€¦","fields":{"slug":"/url-parser-in-swift-functional-style-part-1/"},"frontmatter":{"title":"URL parser in functional style. Part 1.","date":"November 07, 2017"}},"next":{"excerpt":"One of the first tasks I got in my new team was to convert entire code base from in-house JSON encoding/decoding solution (in fact two of them) to Swift nativeâ€¦","fields":{"slug":"/codable-in-practice/"},"frontmatter":{"title":"Codable in practice","date":"May 05, 2018"}}},"pageContext":{"id":"d1a09427-7e5b-55a4-a1da-506f7e136ef6","previousPostId":"d03061a7-a4cd-5362-b15e-7f66ad3e1698","nextPostId":"dbfdbebf-cd01-59b1-8cf8-349b6080a9b5"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}