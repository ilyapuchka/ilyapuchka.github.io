{"componentChunkName":"component---src-templates-blog-post-js","path":"/making-slack-ci-and-fastlane-work-together/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"712711eb-f3b8-5566-828a-85a86b7717b2","excerpt":"Nowadays Slack, some kind of CI and often Fastlane are default tools in a toolset of iOS developers. These tools serve their own purposes well, but wouldn't‚Ä¶","html":"<p>Nowadays Slack, some kind of CI and often Fastlane are default tools in a toolset of iOS developers. These tools serve their own purposes well, but wouldn't they do it better when they all work together? In this tutorial, I'll describe how to connect Slack with CircleCI and Fastlane. I'll be using CircleCI as an example but it's pretty much the same with any modern CI solution. As a bonus, we will do that in Swift using Vapor 3.0. So this tutorial can be as well an introduction to Swift on the server with Vapor framework.</p>\n<h2>Running Fastlane on CI</h2>\n<p>I touched in depth the details of configuring CircleCI in a dynamic way so that you can reuse as much configuration as you can without repeating common steps in each job, so I won't go into details here and will just highlight the main ideas.</p>\n<p>While CircleCI support for triggering workflows with API calls is still very limited we will use a build job. As it's not run as a part of a workflow we will need to define a job that would run all the required steps like <code>checkout</code>, <code>bundle_install</code>, etc. To be able to reuse those steps in other jobs we will define them using YAML aliases (I described this approach <a href=\"https://ilya.puchka.me/parametrised-jobs-in-circleci/\">here</a>, if you already using <a href=\"https://circleci.com/docs/2.0/reusing-config/\">CircleCI 2.1</a> you probably won't need this):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">references:\n    - &amp;fastlane\n            run:\n                name: Fastlane\n                command: |\n                    if [[$CIRCLE_JOB == fastlane]] ; then\n                        if [[-n \"${FASTLANE}\"]]; then\n                eval \"bundle exec fastlane ${FASTLANE} ${OPTIONS}\"\n            fi\n\n    - &amp;all_steps\n            steps:\n                - checkout\n                - *brew\n                - *restore_gems_cache\n                - *bundle_install\n                - *save_gems_cache\n                - *restore_cocoapods_cache\n                - *pod_install\n                - *save_cocoapods_cache\n                - *fastlane\n                - *store_fastlane_output\n\njobs:\n    fastlane:\n        &lt;&lt;: *container_config\n        &lt;&lt;: *all_steps</code></pre></div>\n<p>Alias <code>fastlane</code> defines a step that checks for environment variable <code>CIRCLE_JOB</code> to check if this step is running within a job that was triggered with an API call (it will be the first job defined in the jobs list). Then we check if <code>FASTLANE</code> and <code>OPTIONS</code> environment variables are defined and use them in a call to fastlane.</p>\n<h2>CircleCI service</h2>\n<p>To trigger such job and run a specific lane on CircleCI we need to make a request to the CircleCI API. For that, we create a service type responsible for interacting with CircleCI API.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">CircleCIService</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Service</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> baseURL <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"https://circleci.com\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> headers<span class=\"token punctuation\">:</span> <span class=\"token class-name\">HTTPHeaders</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string-literal\"><span class=\"token string\">\"Content-Type\"</span></span><span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"application/json\"</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-literal\"><span class=\"token string\">\"Accept\"</span></span><span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"application/json\"</span></span>\n    <span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">let</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> project<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Conforming to <code>Service</code> protocol defined in Vapor is not required and in fact, it does not have any requirements, but doing so will allow us to register this type in Vapors DI container which can become handy at some point later.</p>\n</blockquote>\n<p>To work with CircleCI API we'll need a token that you can create on its dashboard and a project name.</p>\n<p>To trigger a job that would run a specific lane we need to make CircleCI aware of this lane name and its options. This is done by sending <code>build_parameters</code> property in the API request body. This key expects strings key-value pairs which will be made accessible to CircleCI as environment variables.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"build_parameters: {\n        \"FASTLANE\": \"test\",\n        \"OPTIONS\": \"branch:master\"\n    }\n}</code></pre></div>\n<p>If the API call successfully triggered a job the response will contain a <code>build_url</code> parameter with a link to the job's dashboard and a branch on which it is running. To work with these parameters we create request and response types:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">CircleCIService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">BuildRequest</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Content</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> buildParameters<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> buildParameters <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"build_parameters\"</span></span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">BuildResponse</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Content</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">let</span> branch<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">let</span> buildURL<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n\n        <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> branch\n            <span class=\"token keyword\">case</span> buildURL <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"build_url\"</span></span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Using <code>Content</code> protocol defined in Vapor is not strictly necessary here - <code>Codable</code> will work just fine, but it makes it slightly easier to encode/decode data in the Vapor environment.</p>\n</blockquote>\n<p>Now we can actually implement the API call:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">CircleCIService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">run</span><span class=\"token punctuation\">(</span>\n        parameters<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        branch<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span>\n        on request<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Request</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Future</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">BuildResponse</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>\n            string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"/api/v1.1/project/github/</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">project</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">/tree/</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">branch</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">?circle-token=</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">token</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n            relativeTo<span class=\"token punctuation\">:</span> baseURL\n        <span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n        <span class=\"token keyword\">let</span> request <span class=\"token operator\">=</span> <span class=\"token class-name\">BuildRequest</span><span class=\"token punctuation\">(</span>buildParameters<span class=\"token punctuation\">:</span> parameters<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">:</span> headers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Slack service</h2>\n<p>To communicate with Slack we will use <a href=\"https://api.slack.com/slash-commands\">slash commands</a>. To implement them we need first to create a Slack app and register a slash command in it. To invoke it we will need to send a Slack message that would like like <code>/fastlane test branch:master</code>, where <code>fastlane</code> is the name of the command (slash commands are always prefixed with <code>/</code>) and the rest is the text of the command that our Vapor app will parse to extract the name of the lane (in this case <code>test</code>) and its options (in this case <code>branch:master</code>).</p>\n<p>When it's done we need to implement the endpoint in our Vapor app that will be called by Slack when someone triggers this slash command. The request made by Slack to this endpoint will contain some metadata in its body that contains the text of the command itself and some additional data, like the channel name where the command was invoked, the security token and response URL (more details about this later).</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">SlackCommandMetadata</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Content</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> channelName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> text<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> responseURL<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n\n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> token\n        <span class=\"token keyword\">case</span> channelName <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"channel_name\"</span></span>\n        <span class=\"token keyword\">case</span> text\n        <span class=\"token keyword\">case</span> responseURL <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"response_url\"</span></span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>After the request is sent to our app by Slack it will expect the response. It should contain a text and flag that would instruct Slack to make the response visible either only to the user who invoked the slash command (that's called \"ephemeral\" response) or to everyone in the channel where the command was invoked.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">SlackResponse</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Content</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> text<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> visibility<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Visibility</span>\n\n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Visibility</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Content</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> user <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"ephemeral\"</span></span>\n        <span class=\"token keyword\">case</span> channel <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"in_channel\"</span></span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> text\n        <span class=\"token keyword\">case</span> visibility <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"response_type\"</span></span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This response can be sent to Slack right after the command was processed as a response to the incoming HTTP request or later using <code>responseURL</code>. This is helpful because Slack has a 3 seconds timeout for slash commands responses. We could just send some generic response right away, i.e. <code>Ok, will trigger CircleCI job now</code>, but it will be more useful if this response would contain a URL to the triggered job. Sometimes CircleCI takes a bit longer to trigger the job and we'll need to wait for it to return the response with a job URL so we will do that by sending this data to the <code>responseURL</code> when a request to CircleCI API returns it.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">Future</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">T</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">SlackResponse</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">replyLater</span><span class=\"token punctuation\">(</span>\n        withImmediateResponse immediateResponse<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SlackResponse</span><span class=\"token punctuation\">,</span>\n        responseURL<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span>\n        on request<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Request</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Future</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">SlackResponse</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token omit keyword\">_</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span>\n            <span class=\"token punctuation\">.</span>mapIfError <span class=\"token punctuation\">{</span> <span class=\"token class-name\">SlackResponse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>localizedDescription<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">.</span>flatMap <span class=\"token punctuation\">{</span> response <span class=\"token keyword\">in</span>\n                <span class=\"token keyword\">try</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>responseURL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">try</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">.</span>eventLoop<span class=\"token punctuation\">.</span><span class=\"token function\">future</span><span class=\"token punctuation\">(</span>immediateResponse<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now to be able to handle a slash command in our app we need to describe it in code. For that we will introduce a <code>SlackCommand</code> type responsible for parsing the incoming request, triggering CircleCI service and sending results back to Slack, and <code>SlackService</code> responsible for handling a command on a high level:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">SlackCommand</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> help<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> run<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SlackCommandMetadata</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Request</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Future</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">SlackResponse</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">SlackService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">handle</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SlackCommand</span><span class=\"token punctuation\">,</span> on request<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Request</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Future</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Response</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> request<span class=\"token punctuation\">.</span>content\n            <span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SlackCommandMetadata</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>flatMap <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>token<span class=\"token punctuation\">]</span> metadata <span class=\"token keyword\">in</span>\n                <span class=\"token keyword\">guard</span> metadata<span class=\"token punctuation\">.</span>token <span class=\"token operator\">==</span> token <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">throw</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">.</span>invalidToken\n                <span class=\"token punctuation\">}</span>\n                \n                <span class=\"token keyword\">if</span> metadata<span class=\"token punctuation\">.</span>text <span class=\"token operator\">==</span> <span class=\"token string-literal\"><span class=\"token string\">\"help\"</span></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">future</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SlackResponse</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">.</span>help<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> command<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">.</span>mapIfError <span class=\"token punctuation\">{</span> <span class=\"token class-name\">SlackResponse</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>localizedDescription<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n        \n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">SlackService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Swift</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Error</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> invalidToken\n        <span class=\"token keyword\">case</span> <span class=\"token function\">missingParameter</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token function\">invalidParameter</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> expected<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>First <code>SlackService</code> extracts the command metadata from the incoming request and verifies its token (Slack docs say that it's a deprecated way of verifying requests made by Slack but its fine for our purposes for now). Then if the request was to show the command usage instructions (i.e. <code>/fastlane help</code>) we return these instructions in the response. Otherwise, we trigger the command using its <code>run</code> closure.</p>\n<p>Now we have everything ready to implement the actual command:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">SlackCommand</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> fastlane <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>ci<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CircleCIService</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n        <span class=\"token class-name\">SlackCommand</span><span class=\"token punctuation\">(</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"fastlane\"</span></span><span class=\"token punctuation\">,</span>\n            help<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Invokes specified lane on specified branch...\"</span></span><span class=\"token punctuation\">,</span>\n            run<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> metadata<span class=\"token punctuation\">,</span> request <span class=\"token keyword\">in</span>\n                <span class=\"token keyword\">try</span> <span class=\"token function\">runLane</span><span class=\"token punctuation\">(</span>\n                    metadata<span class=\"token punctuation\">:</span> metadata<span class=\"token punctuation\">,</span>\n                    ci<span class=\"token punctuation\">:</span> ci<span class=\"token punctuation\">,</span>\n                    on<span class=\"token punctuation\">:</span> request\n                <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">runLane</span><span class=\"token punctuation\">(</span>\n        metadata<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SlackCommandMetadata</span><span class=\"token punctuation\">,</span>\n        ci<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CircleCIService</span><span class=\"token punctuation\">,</span>\n        on request<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Request</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Future</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">SlackResponse</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> components <span class=\"token operator\">=</span> metadata<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">.</span><span class=\"token function\">components</span><span class=\"token punctuation\">(</span>separatedBy<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\" \"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> lane <span class=\"token operator\">=</span> components<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">let</span> options <span class=\"token operator\">=</span> components<span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">joined</span><span class=\"token punctuation\">(</span>separator<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\" \"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> branch <span class=\"token operator\">=</span> components<span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>first <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasPrefix</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"branch:\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token operator\">?</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"branch:\"</span></span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> parameters <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"FASTLANE\"</span></span><span class=\"token punctuation\">:</span> lane<span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">\"OPTIONS\"</span></span><span class=\"token punctuation\">:</span> options<span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> ci\n            <span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>\n                parameters<span class=\"token punctuation\">:</span> parameters<span class=\"token punctuation\">,</span>\n                branch<span class=\"token punctuation\">:</span> branch <span class=\"token operator\">??</span> <span class=\"token string-literal\"><span class=\"token string\">\"master\"</span></span><span class=\"token punctuation\">,</span>\n                on<span class=\"token punctuation\">:</span> request\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>map <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CircleCIService</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">BuildResponse</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n                <span class=\"token class-name\">SlackResponse</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"\"\"\n                    üöÄ Triggered `</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">lane</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">` on the `</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">response<span class=\"token punctuation\">.</span>branch</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">` branch.\n                    </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">response<span class=\"token punctuation\">.</span>buildURL</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\n                    \"\"\"</span></span><span class=\"token punctuation\">,</span>\n                    visibility<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>channel\n                <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">replyLater</span><span class=\"token punctuation\">(</span>\n                withImmediateResponse<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SlackResponse</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"üëç\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                responseURL<span class=\"token punctuation\">:</span> metadata<span class=\"token punctuation\">.</span>responseURL<span class=\"token punctuation\">,</span>\n                on<span class=\"token punctuation\">:</span> request\n            <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Our command first performs some trivial string parsing to extract a lane name, its options, and a branch name and then uses that in a call to CircleCI service. When this call completes we convert its response to the Slack message that contains the job URL and we send it back to the Slack as a delayed response.</p>\n<p>To connect all these pieces together we now need to register a route in our Vapor app in the <code>routes.swift</code> file :</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">routes</span><span class=\"token punctuation\">(</span>\n    router<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Router</span><span class=\"token punctuation\">,</span>\n    slack<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SlackService</span><span class=\"token punctuation\">,</span>\n    commands<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">SlackCommand</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token punctuation\">{</span>\n    commands<span class=\"token punctuation\">.</span>forEach <span class=\"token punctuation\">{</span> command <span class=\"token keyword\">in</span>\n        router<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> req <span class=\"token operator\">-></span> <span class=\"token class-name\">Future</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Response</span><span class=\"token operator\">></span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> slack<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">:</span> command<span class=\"token punctuation\">,</span> on<span class=\"token punctuation\">:</span> req<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> <span class=\"token class-name\">SlackResponse</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>localizedDescription<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> req<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>and configure Slack and CircleCI services in the <code>configure.swift</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> config<span class=\"token punctuation\">:</span> <span class=\"token keyword\">inout</span> <span class=\"token class-name\">Config</span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> env<span class=\"token punctuation\">:</span> <span class=\"token keyword\">inout</span> <span class=\"token class-name\">Environment</span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> services<span class=\"token punctuation\">:</span> <span class=\"token keyword\">inout</span> <span class=\"token class-name\">Services</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> slack <span class=\"token operator\">=</span> <span class=\"token class-name\">SlackService</span><span class=\"token punctuation\">(</span>\n        token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Environment</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"SLACK_TOKEN\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">let</span> ci <span class=\"token operator\">=</span> <span class=\"token class-name\">CircleCIService</span><span class=\"token punctuation\">(</span>\n        token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Environment</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"CIRCLECI_TOKEN\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n        project<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Environment</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"CIRCLECI_PROJECT\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">let</span> router <span class=\"token operator\">=</span> <span class=\"token class-name\">EngineRouter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span> <span class=\"token function\">routes</span><span class=\"token punctuation\">(</span>\n        router<span class=\"token punctuation\">:</span> router<span class=\"token punctuation\">,</span> \n        slack<span class=\"token punctuation\">:</span> slack<span class=\"token punctuation\">,</span> \n        commands<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">fastlane</span><span class=\"token punctuation\">(</span>ci<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">,</span> <span class=\"token keyword\">as</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Router</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And we are done! If you want to test the app you need to set environment variables in the Xcode scheme and just run the app. It will run it on the <code>localhost</code> and you'll be able to send requests to it (I use <a href=\"https://insomnia.rest\">Insomnia</a> for that). Then deploy the app to the platform of your choice (we use Heroku for that), update the slash command with the actual URL of your app and enjoy!</p>\n<h2>Conclusion</h2>\n<p>In Babylon iOS team we use this integration dozen of times daily and it proved to be very useful. So we decided to share it with the community and to opensource our app! We call it <code>Stevenson</code> - the original app, written with Vapor 2.0, was called <code>Steve</code> - and you can find it on our <a href=\"https://github.com/Babylonpartners/Stevenson\">GitHub</a>. It contains the code for our app itself and a reusable framework that you can use in your own apps. If you use or built yourself similar Slack apps in your team we'll be happy to hear from you about how you use them!</p>","fields":{"slug":"/making-slack-ci-and-fastlane-work-together/"},"frontmatter":{"id":"5ca0c61ee50b131c1451e27f","title":"Making Slack, CircleCI and Fastlane work together","date":"June 08, 2019","description":"Nowadays Slack, some kind of CI and often Fastlane are default tools in a toolset of iOS developers. These tools serve their own purposes well, but wouldn't they do it better when they all work together? In this tutorial, I'll describe how to connect Slack with CircleCI and Fastlane. I'll be using CircleCI as an example but it's pretty much the same with any modern CI solution. As a bonus, we will do that in Swift using Vapor 3.0. So this tutorial can be as well an introduction to Swift on the server with Vapor framework.","tags":""}},"previous":{"excerpt":"Strings are everywhere. We all use strings everyday. In Swift String is a very powerful type. One of the features it had available since the beginning is the‚Ä¶","fields":{"slug":"/swift5-string-interpolation/"},"frontmatter":{"title":"Swift 5 string interpolation","date":"February 06, 2019"}},"next":{"excerpt":"Recently we were discussing in our team how to approach having fixes for bugs discovered during release both in release and the trunk branch to ensure we don't‚Ä¶","fields":{"slug":"/git-rebase-vs-git-rebase-onto/"},"frontmatter":{"title":"git rebase vs. git rebase --onto","date":"November 10, 2019"}}},"pageContext":{"id":"712711eb-f3b8-5566-828a-85a86b7717b2","previousPostId":"4cc51020-7b3b-5a1a-9bc6-396d7b045c6e","nextPostId":"dfe312ec-9c5e-5f86-8691-1b86834bafa5"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}