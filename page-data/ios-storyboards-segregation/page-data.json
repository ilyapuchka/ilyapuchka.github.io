{"componentChunkName":"component---src-templates-blog-post-js","path":"/ios-storyboards-segregation/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"ea36fe89-9adf-54e2-92db-19bee4ddc1ee","excerpt":"Recently here at Rambler&Co mobile team we decided to try technique of storyboards segregation (separation in other words). We came to the conclusion that this…","html":"<p>Recently here at Rambler&#x26;Co mobile team we decided to try technique of storyboards segregation (separation in other words). We came to the conclusion that this simple technique together with other techniques we use can help us to improve our's projects architecture, code readability and stability. Here is what we came up with.</p>\n<p>Many techniques of applications development are based on <a href=\"http://en.wikipedia.org/wiki/User_story\">user stories</a> (or <a href=\"http://en.wikipedia.org/wiki/Use_case\">use cases</a>), in short - small logically connected pieces of functionality that application provides to user. Developers too also use the term of 'use cases' in application architecture design. So why not to use this concept to devide one massive storyboard in smaller pieces?</p>\n<p>Usually if you are using storyboards in your project you may have at least one storyboard. If you have relatively simple project with few screens and transitions it is just fine - most likely you will also have very few user stories. But if you have some kind of large project with lots of different screens (e.g. <a href=\"/restaurants\">Afisha-Restaurants</a>) and possible segues among them then separating your single storyboard in several smaller storyboards can help you to maintain your code (by maintaining I mean i.e. merging storyboards) and to be clear about what transitions you have and where they point.</p>\n<p>To go from one storyboard to another we need some special segue. What our cross-storyboard segue should do is to substitute it's destination view controller that it get's when segue is created by UIKit with some other view controller from another storyboard. First we must decide how our segue will know where to get it's destination view controller from. There are two ways. <a href=\"http://spin.atomicobject.com/2014/03/06/multiple-ios-storyboards/\">One</a> is to include this information in segue itself, right in it's identifier. <a href=\"https://github.com/rob-brown/RBStoryboardLink\">Another</a> is to include this information in destination view controller using some placeholder in place of view controller in source storyboard. First one is fairly simple and fully described in linked blog post. We will go the second way cause I like it more than tying up with segue identifiers. And we will use the power of Objective-C runtime.</p>\n<p>To make our view controllers hold information about thier storyboards and thier storyboard identifiers we create a category of <code>UIViewController</code> that will add two properties - <code>storyboardName</code> and <code>storyboardIdentifier</code>. The first should match actual name of storyboard that contains view controller. The second should match view controller's storyboard ID from view controller's identity inspector (<code>UIViewController</code> does not provide such property from the box, so we have to duplicate it).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@interface UIViewController (Storyboards)\n\n@property (nonatomic, copy) IBInspectable NSString *storyboardName;\n@property (nonatomic, copy) IBInspectable NSString *storyboardIdentifier;\n\n@end</code></pre></div>\n<p>The <code>IBInspectable</code> keyword will let us set this properties right in Interface Builder. In fact what this keyword does is just adding input fields for corresponding properties to attributes inspector. But you can (and always could) do the same using plane old runtime attributes in identity inspector. IBInspectable-marked properties will be automatically detected by Interface Builder no matter where they are declared.</p>\n<p>Also we will add convenient method to create view controllers using this two properties:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+ (instancetype)viewControllerFromStoryboardWithName:(NSString *)storyboardName withStoryboardIdentifier:(NSString *)storyboardIdentifier;</code></pre></div>\n<p>Implementation looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#import &lt;objc/runtime.h>\n\n@implementation UIViewController (Storyboards)\n\n- (NSString *)storyboardName\n{\n    return objc_getAssociatedObject(self, @selector(storyboardName));\n}\n\n- (void)setStoryboardName:(NSString *)storyboardName\n{\n    objc_setAssociatedObject(self, @selector(storyboardName), storyboardName, OBJC_ASSOCIATION_COPY_NONATOMIC);\n}\n\n- (NSString *)storyboardIdentifier\n{\n    return objc_getAssociatedObject(self, @selector(storyboardIdentifier));\n}\n\n- (void)setStoryboardIdentifier:(NSString *)storyboardIdentifier\n{\n    objc_setAssociatedObject(self, @selector(storyboardIdentifier), storyboardIdentifier, OBJC_ASSOCIATION_COPY_NONATOMIC);\n}\n\n+ (instancetype)viewControllerFromStoryboardWithName:(NSString *)storyboardName withStoryboardIdentifier:(NSString *)storyboardIdentifier\n{\n    if (storyboardName.length > 0 &amp;&amp; storyboardIdentifier.length > 0) {\n        UIStoryboard *storyboard = [UIStoryboard storyboardWithName:storyboardName bundle:nil];\n        if (storyboard) {\n            return [storyboard instantiateViewControllerWithIdentifier:storyboardIdentifier];\n        }\n    }\n    return nil;\n}\n\n@end</code></pre></div>\n<p>Really no need for comments (if you need read <a href=\"http://nshipster.com/associated-objects/\">this NSHipster blog post</a> for associated objects reference).</p>\n<p>Now let's implement our \"magic\" segue. We can do this by subclassing <code>UIStoryboardSegue</code> but then we will have to create subclasses for every kind of presentation we use. Instead we will use method swizzling (I will no go into details of swizzling, check out <a href=\"http://nshipster.com/method-swizzling/\">this NSHipster blog post</a> for reference). With this code even your custom segues will work with view controllers from other storyboards with no need to modify segue code.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">//interface\n@interface UIStoryboardSegue (Storyboards)\n\n@end\n\n//implementation\n#include \"UIViewController+Storyboards.h\"\n#import \"NSObject+Swizzling.h\"\n\n@implementation UIStoryboardSegue (Storyboards)\n\n+ (void)load\n{\n    static dispatch_once_t onceToken;\n    dispatch_once(&amp;onceToken, ^{\n        //Using NSObject category that actually performs swizzling\n        [self swizzleSelector:@selector(initWithIdentifier:source:destination:) withSelector:@selector(storyboards_initWithIdentifier:source:destination:)];\n    });\n}\n\n- (instancetype)storyboards_initWithIdentifier:(NSString *)identifier source:(UIViewController *)source destination:(UIViewController *)destination\n{\n    return [self storyboards_initWithIdentifier:identifier source:source destination:[self destinationWithDestination:destination]];\n}\n\n- (UIViewController *)destinationWithDestination:(UIViewController *)destination\n{\n    UIViewController *newDestination = [UIViewController viewControllerFromStoryboardWithName:destination.storyboardName withStoryboardIdentifier:destination.storyboardIdentifier];\n    return newDestination?:destination;\n}\n\n@end</code></pre></div>\n<p>That's all with code for now. Now let's see how to use this in the project.</p>\n<ul>\n<li>In your main storyboard select view controller(s) you want to separate to other storyboard. Create new storyboard and move selected controllers there.</li>\n<li>In original storyboard leave the first of selected view controllers which will correspond to initial view controller of newly created storyboard. Now remove it's view - you just does not need it here any more cause you now have it in other storyboard. Now we have a placeholder for real view controller that will be loaded from other storyboard.</li>\n<li>Set <code>storyboardName</code> and <code>storyboardIdentifier</code> for this placeholder.</li>\n</ul>\n<p><em>Remember that storyboard name should be the name of storyboard to load view controller and storyboard identifier should match one of this storyboard view controllers' stroyboard IDs (I always recommend to use view controller's class name for storyboard ID)</em>.</p>\n<p>And you are done. When segue will be performed view controller will be loaded from storyboard with provided name. It can be any view controller in the storyboard, not necessarily initial view controller.</p>\n<p>Of course this technique has some disadvantages and side effects you should concider. For example <code>-(id)initWithCoder:</code> and <code>-(void)awakeFromNib</code> will be called twice for controllers that are used in two different storyboards. Wherein <code>-(void)viewDidLoad</code> is called once. You can get rid of this by setting base class to <code>UIViewController</code> for this controllers' placeholders. Anyway two controllers will be instantiated but at least this will not call your own code twice.<br>\nYou can also consider for yourself using runtime as disadvantage. Than you can use subclassing.</p>\n<p>One more thing that should be mentioned is what if we have <code>UINavigationController</code> or <code>UITabBarController</code> (and likely <code>UISplitViewController</code> too)? For instance <code>UITabBarController</code>'s child view controllers are set in storyboards using relationships, not segues and we can not customize relationships. So if you want to devide your storyboard by tab bar items you have a problem. But it's easy to fix using what we have done already. Remember we added convenient method in our <code>UIViewController</code> category that can create view controllers using storyboard name and storyboard identifier? Let's use it. Also we will need some method swizzling again. If you prefer not to use method swizzling you can create subclass or user other techniques, like dependecy injection, but for me it's too much for this simple task.</p>\n<p>Let's add <code>UITabBarController</code> category and swizzle it's <code>-(void)awakeFromNib</code> method (it will look absolutelly the same way for <code>UINavigationController</code> and actually as far as <code>UITabBarController</code> and <code>UINavigationController</code> does not override <code>UIViewController</code>'s implementation of <code>-awakeFromNib</code> we can swizzle this method just in <code>UIViewController</code>). When this method is called <code>viewControllers</code> property of the instance is already set and all view controllers in this array already has their custom <code>storyboardName</code> and <code>storyboardIdentifier</code> properties set.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">//interface\n@interface UITabBarController(Storyboards)\n\n@end\n\n//implementation\n#import \"NSObject+Swizzling.h\"\n\n@implementation UITabBarController(Storyboards)\n\n+ (void)load\n{\n    static dispatch_once_t onceToken;\n    dispatch_once(&amp;onceToken, ^{\n        [self swizzleSelector:@selector(awakeFromNib) withSelector:@selector(storyboards_awakeFromNib)];\n    });\n}\n\n- (void)storyboards_awakeFromNib\n{\n    [self storyboards_awakeFromNib];\n\n    NSMutableArray *viewControllers = [self.viewControllers mutableCopy];\n    [self.viewControllers enumerateObjectsUsingBlock:^(UIViewController *vc, NSUInteger idx, BOOL *stop) {\n        UIViewController *newVC = [UIViewController viewControllerFromStoryboardWithName:vc.storyboardName withStoryboardIdentifier:vc.storyboardIdentifier];\n        if (newVC) {\n            [viewControllers replaceObjectAtIndex:idx withObject:newVC];\n        }\n    }];\n    [self setViewControllers:viewControllers];\n}\n\n@end</code></pre></div>\n<p>Here we replace view controllers from <code>viewControllers</code> property with view controllers loaded from other storyboards.<br>\nNow if you have <code>UITabBarController</code> as your root view controller your initial storyboard can contain just this controller and placeholders for it's child view controllers.</p>\n<p>As a result all we have to do to separate storyboards is to set storyboard names and storyboard identifiers for some of our view controllers. With little efforts we are now able to maintain and read our storyboards easily and structure our code using cleaner architecture.</p>\n<p>Related links:</p>\n<ol>\n<li><a href=\"https://github.com/ilyapuchka/StoryboardsSegregation\">Sample project</a></li>\n<li><a href=\"http://spin.atomicobject.com/2014/03/06/multiple-ios-storyboards/\">Easier Multiple Storyboards in iOS with Custom Segues</a></li>\n<li><a href=\"https://github.com/rob-brown/RBStoryboardLink\">https://github.com/rob-brown/RBStoryboardLink</a></li>\n<li><a href=\"http://nshipster.com/associated-objects/\">http://nshipster.com/associated-objects/</a></li>\n<li><a href=\"http://nshipster.com/method-swizzling/\">http://nshipster.com/method-swizzling/</a></li>\n</ol>\n<p><strong>UPDATE</strong></p>\n<p>For cases when you don't use segues but instantiate and present view controllers manually we can add category for UIStoryboard that swizzles it's <code>-(id)instantiateViewControllerWithIdentifier:</code>. As we can not make iOS to use subclasses of UIStoryboard subclassing will not help here. Sample project is updated.</p>\n<p><strong>UPDATE</strong></p>\n<p>Basing on feedback from my colleagues and <a href=\"http://blog.newrelic.com/2014/04/16/right-way-to-swizzle/\">this article</a> about the \"right way\" of method swizzling I reimplemented this part of code and updated sample porject. The reset of implementation has not changed.<br>\nFinal code will look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">//UIViewController+Storyboards.h\n\n+ (void)swizzleAwakeFromNib\n{\n    SEL sel = @selector(awakeFromNib);\n    Method method = class_getInstanceMethod([UIViewController class], sel);\n    ObjCMsgSendReturnNil originalImp = (ObjCMsgSendReturnNil)method_getImplementation(method);\n\n    //UITabBarController and UINavigationController does not override -awakeFromNib, so we can swizzle UIViewController base implementation and check instance class.\n    IMP adjustedImp = imp_implementationWithBlock(^void(UINavigationController *instance) {\n        originalImp(instance, sel);\n        if ([instance isKindOfClass:[UINavigationController class]] ||\n            [instance isKindOfClass:[UITabBarController class]]) {\n            NSArray *newViewControllers = [instance viewControllersWithViewController:[instance viewControllers]];\n            [instance setViewControllers:newViewControllers];\n        }\n    });\n\n    method_setImplementation(method, adjustedImp);\n}</code></pre></div>","fields":{"slug":"/ios-storyboards-segregation/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f5c","title":"iOS storyboards segregation","date":"December 08, 2014","description":"Recently here at Rambler&Co mobile team we decided to try technique of storyboards segregation (separation in other words). We came to the conclusion that this simple technique together with other techniques we use can help us to improve our's projects architecture, code readability and stability. Here is what we came up with.","tags":""}},"previous":null,"next":{"excerpt":"This is quiet interesting XCode feature I was not aware of until last week. Maybe you will find it not so interesting and definitely will not use this on…","fields":{"slug":"/info-plist-preprocessing/"},"frontmatter":{"title":"Info.plist preprocessing","date":"December 13, 2014"}}},"pageContext":{"id":"ea36fe89-9adf-54e2-92db-19bee4ddc1ee","previousPostId":null,"nextPostId":"15bd9e30-24bf-5a0e-836b-d13c6265993f"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}