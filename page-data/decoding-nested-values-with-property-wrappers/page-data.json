{"componentChunkName":"component---src-templates-blog-post-js","path":"/decoding-nested-values-with-property-wrappers/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"c0cd6b60-c62f-58eb-89ca-8d6ecbc754bd","excerpt":"Property wrappers is one of the recent Swift proposals that have been welcomed probably the most by the community. To be fair though they don't bring anythingâ€¦","html":"<p>Property wrappers is one of the recent Swift proposals that have been welcomed probably the most by the community. To be fair though they don't bring anything relly revolutionary to the way we write code. For instance in the context of decoding we could use wrapper types from day one. The main difference that property wrappers make (let's forget about their projected value feature) in this context and which makes using them much more attractive is ability to refer to a wrapped value as it was not wrapped. But that makes all the difference. So let's see how property wrappers can be used to solve one decoding edge case as an example - decoding deeply nested values.</p>\n<h2>The problem</h2>\n<p>It's common that when decoding some type we want to get access to some value deep down the chain of nested objects. The most trivial approach to do that would be to declare all the intermediate types and properties so that compiler can generate all the code for us. But we, developers, are lazy and don't like to write boilerplate code that we won't use otherwise. Also this approach means that we would need to access these nested values through a long chain of properties, or we would need to write even more boilerplate to incapsulate that.</p>\n<p>Wouldn't be nice if we could decode nested values without all these intermediate types and properties baggage? It turns out we can do that and it is pretty easy to do without even fighting the standard library (almost).</p>\n<h2>Decoding a single nested value</h2>\n<p>Let's say we have a JSON of the following format:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"id\": \"1\",\n    \"user\": {\n        \"details\": {\n            \"address\": \"Apple St.\"\n        }\n    }\n}</code></pre></div>\n<p>And we want to decode it into the following struct:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> address<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Out of the box compiler won't generate the code that would be able to decode such JSON in this struct as it does not know about intermediate <code>\"user\"</code> and <code>\"details\"</code> keys. Without declaring all the intermediate data structures we would need to implement decoding manually like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> id\n    <span class=\"token keyword\">case</span> user\n    <span class=\"token keyword\">case</span> details\n    <span class=\"token keyword\">case</span> address\n<span class=\"token punctuation\">}</span>\n    \n<span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>from decoder<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decoder</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> values <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> decoder<span class=\"token punctuation\">.</span><span class=\"token function\">container</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> values<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>address <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> values\n        <span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>details<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you see we not only have to implement all the decoding code but also define all the coding keys ourselves. It's not a hard thing to do but can be a lot of typing. Ideally we don't want to implement decoding and to define all the coding keys manually.</p>\n<p>To start let's highlight what's missing for the compiler to generate this code for us. First thing that is missing is intermediate coding keys. Compiler generates coding keys based on the stored properties of our type, so in our case it will generate <code>id</code> and <code>address</code> keys, but <code>details</code> and <code>user</code> keys will be missing.</p>\n<p>Next thing that is missing is a link between the <code>address</code> property and its key path in the JSON structure. Compiler does not know that to extract <code>address</code> value it needs to go through <code>user</code> and <code>details</code> objects first. If we will be able to provide this link to the compiler somehow then we will be able to remove our custom decoding constructor and just rely on compiler generated code.</p>\n<p>So what we need to do now is to somehow abstract this code:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>address <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> values\n    <span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>details<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span></code></pre></div>\n<p>To do that we need to know the order of the keys and their values. In this case the order is <code>.user</code>, <code>.details</code>, <code>.address</code>. Then we need to know the type of the property we are decoding, which is a <code>String</code>.</p>\n<p>When compiler generates decoding code for us it generates calls to the methods of <code>KeyedDecodingContainer</code> which all look like <code>func decode&#x3C;T>(_: T.Type, forKey key: Key) throws -> T</code>. To decode <code>address</code> property compiler will generate a call to <code>decode(String.self, forKey: .address)</code>. So there seem to be no direct way for us to inject the missing keys. And here comes the wrapper.</p>\n<p>To hold the intermediate keys that compiler needs to use to generate code we can define a special wrapper type, let's call it <code>NestedDecodable</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span>\n    <span class=\"token keyword\">let</span> keys<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we can declare our address property as wrapped in this type:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> address <span class=\"token operator\">=</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n    keys<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">,</span> \n        <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span>details<span class=\"token punctuation\">,</span> \n        <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span>address\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>This though won't work as this property will be initialised even before invoking a decoder and we don't have wrapped value to pass to it. So instead we can only declare its type as wrapped into <code>NestedDecodable</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> address <span class=\"token operator\">=</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token operator\">></span></code></pre></div>\n<p>But now we don't have a way to specify the keys... We will make it right later but for now let's leave it as it is and move on to the decoding container.</p>\n<p>With the code we have so far compiler will generate the code that will try to decode address with <code>decode(NestedDecodable&#x3C;String>.self, forKey: .address)</code>. As <code>NestedDecodable</code> and it's wrapped value are as well decodable types then compiler will generate decoding initialiser for it as well, which will try to decode its wrapped value and coding keys. But both of these properties are not present in the JSON so we can't rely on compiler generated code as it is now.</p>\n<p>Instead we can define a specialised decoding function on <code>KeyedDecodingContainer</code> that would decode values of this type with an extension:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">KeyedDecodingContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">decode</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">,</span> forKey key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we would want to decode the value and return it wrapped into the <code>NestedDecodable</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">KeyedDecodingContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">decode</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">,</span> forKey key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> wrappedValue <span class=\"token operator\">=</span> <span class=\"token operator\">...</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> wrappedValue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For that we would need to adjust a constructor of <code>NestedDecodable</code> to accept wrapped value:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>wrappedValue <span class=\"token operator\">=</span> wrappedValue\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>But now we don't really have a place where to store the nested keys values. As a matter of fact we don't really need them to be stored in <code>NestedDecodable</code> any more as we would need to use them before we even create an instance of <code>NestedDecodable</code>. But without this instance the only thing we have is the type <code>NestedDecodable&#x3C;T>.Type</code>.</p>\n<p>How can we get the list of nested keys when we have only information about types? Remember that coding keys are enums (technically it's not a requirement). How knowing an enum type can we get a list of enum values? Sounds familiar? Right, it's <code>CaseIterable</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> id\n    <span class=\"token keyword\">case</span> user\n    <span class=\"token keyword\">case</span> details\n    <span class=\"token keyword\">case</span> address\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">.</span>allCases <span class=\"token operator\">==</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>details<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">]</span></code></pre></div>\n<p>Almost what we need, except we have all the keys here, but when decoding <code>address</code> we need only <code>user</code>, <code>details</code> and <code>address</code>. Also we need to have these keys exactly in this order as this is the order we would need to go through the JSON. We still need to have <code>id</code> key for <code>id</code> property, so let's define a separate type for address keys:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">....</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> id\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> user<span class=\"token punctuation\">,</span> details<span class=\"token punctuation\">,</span> address\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">.</span>allCases <span class=\"token operator\">==</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>details<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">]</span></code></pre></div>\n<p>Great! Now we need to make our <code>NestedDecodable</code> type aware about these extra coding keys type, which we can do by adding another generic parameter to it:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Keys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">CaseIterable</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> address<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token operator\">></span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> id\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> user<span class=\"token punctuation\">,</span> details<span class=\"token punctuation\">,</span> address\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With that we need to update the signature of our <code>KeyedDecodingContainer</code> extension and we can finally access nested coding keys:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">KeyedDecodingContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">decode</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">,</span> forKey key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> keys <span class=\"token operator\">=</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases\n        <span class=\"token keyword\">let</span> wrappedValue <span class=\"token operator\">=</span> <span class=\"token operator\">...</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> wrappedValue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we have everything to start to decode our values. First we would need to get hold of the nested container for <code>user</code> key, then its nested container for <code>details</code> key and finally we would be able to decode the <code>address</code> value. As this is a generic method we don't really know how many nested keys we will have and what will be their actual values, so our method should be generic enough to be able to decode any value with any number of nested keys. For that we will simply iterate over the list of keys and get a nested container for each of the key until we rich the last one which we will use to finally decode the value:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">var</span> container<span class=\"token punctuation\">:</span> <span class=\"token class-name\">KeydDecodingContainer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span>\n<span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span><span class=\"token function\">dropLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>forEach <span class=\"token punctuation\">{</span> key <span class=\"token keyword\">in</span>\n    container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">let</span> wrappedValue <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>lastCase<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> wrappedValue<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Unfortunatelly this won't work because when we get the nested container for the first key we don't have a <code>container</code> instance initialised to call <code>nestedContainer</code> on. We only have <code>self</code> which is a container itself, but it has a different type <code>KeyedDecodingContainer&#x3C;Key></code> as <code>Key</code> and <code>NestedKeys</code> are different types. So if we will try to use <code>self</code> as initial value <code>var container: KeyedDecodingContainer&#x3C;NestedKeys> = self</code> the types will mismatch. But as soon as we have a first nested container we will always have <code>KeyedDecodingContainer&#x3C;NestedKeys></code> down the way. Seems like we need to handle the first key separately. So let's do that:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">var</span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>first<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">dropLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>forEach <span class=\"token punctuation\">{</span> key <span class=\"token keyword\">in</span>\n    container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">let</span> wrappedValue <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>lastCase<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> wrappedValue<span class=\"token punctuation\">)</span></code></pre></div>\n<p>This still won't compile though - to call <code>self.nestedContainer</code> we need to pass it a key value that is of container's key type, in this case it's <code>Key</code> (at runtime it will be <code>Contact.CodingKeys</code>), but <code>NestedKeys.allCases.first</code> is a <code>NestedKey</code>...</p>\n<p>There is also another problem that right now we only have an <code>id</code> key defined in the <code>Contact.CodingKeys</code>. So compiler will complain that a key for <code>address</code> property is missing. Let's add it then.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> id\n    <span class=\"token keyword\">case</span> address\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now compiler will call our extension <code>decode</code> method with the <code>address</code> key and we can use it instead of the <code>NestedKeys.allCases.first</code> to get the first nested container. But we need to make sure we set the raw value of this key to the actual root key, which is <code>\"user\"</code> in our case. With that we won't need <code>user</code> key in <code>Contact.AddressCodingKeys</code> any more:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> id\n    <span class=\"token keyword\">case</span> address <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"user\"</span></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> details<span class=\"token punctuation\">,</span> address\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">KeyedDecodingContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">decode</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">,</span> forKey key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n        <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span><span class=\"token function\">dropLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>forEach <span class=\"token punctuation\">{</span> key <span class=\"token keyword\">in</span>\n            container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> wrappedValue <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>lastCase<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> wrappedValue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This will finally compile and actually work in runtime! It looks a bit weird that we have two <code>address</code> keys but one of them is actually a <code>\"user\"</code> key, but that's the way to make compiler happy.</p>\n<p>Let's sum up all the code we have right now to see that it's actually not that much:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token keyword\">let</span> address<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token operator\">></span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> id\n        <span class=\"token keyword\">case</span> address <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"user\"</span></span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> details<span class=\"token punctuation\">,</span> address\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Keys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">CaseIterable</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>wrappedValue <span class=\"token operator\">=</span> wrappedValue\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">KeyedDecodingContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">decode</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">,</span> forKey key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>isEmpty <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">throw</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">var</span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n        <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span><span class=\"token function\">dropLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>forEach <span class=\"token punctuation\">{</span> key <span class=\"token keyword\">in</span>\n            container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> wrappedValue <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>lastCase<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> wrappedValue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> lastCase<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Self</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> allCases<span class=\"token punctuation\">.</span>isEmpty <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> lastIndex <span class=\"token operator\">=</span> allCases<span class=\"token punctuation\">.</span><span class=\"token function\">index</span><span class=\"token punctuation\">(</span>allCases<span class=\"token punctuation\">.</span>endIndex<span class=\"token punctuation\">,</span> offsetBy<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> allCases<span class=\"token punctuation\">[</span>lastIndex<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we can decode our <code>Contact</code> type and access its address. The only drawback is that <code>address</code> property is not a <code>String</code> any more but a <code>NestedDecodable&#x3C;String, Contact.AddressCodingKeys></code>. We still can access the actual string quite easily with <code>address.wrappedValue</code>, but we now would need to do that everywhere, which is nasty.</p>\n<p>By now you already noticed thought that our <code>NestedDecodable</code> type perfectly matches property wrapper requirements, which is a <code>wrappedValue</code> property and <code>init(wrappedValue:)</code> initialiser. So we can go on and annotate it without changing anything else:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@propertyWrapper</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Keys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">CaseIterable</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>wrappedValue <span class=\"token operator\">=</span> wrappedValue\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we can change how we declare our <code>address</code> property and with that we can access it directly as a string without even knowing that it was wrapped in the first place:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> address<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> id\n        <span class=\"token keyword\">case</span> address <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"user\"</span></span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> details<span class=\"token punctuation\">,</span> address\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> contact <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token class-name\">JSONDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Contact</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">:</span> jsonData<span class=\"token punctuation\">)</span>\ncontact<span class=\"token punctuation\">.</span>address <span class=\"token operator\">==</span> <span class=\"token string-literal\"><span class=\"token string\">\"Apple St.\"</span></span></code></pre></div>\n<p>And that's the main \"magic\" of property wrappers.</p>\n<h2>Decoding multiple nested value</h2>\n<p>Now when we can decode a single nested value we can declare as many <code>NestedDecodable</code> properties as we want, we can even completely get rid of any nested types in our data models and make them all flat (in real life you wouldn't do that of course). Let's try to add another nested property, let's say a name. Our JSON will look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"id\": \"1\",\n    \"user\": {\n        \"details\": {\n            \"address\": \"Apple St.\"\n            \"name\": \"Jhon Appleseed\"\n        }\n    }\n}</code></pre></div>\n<p>We will need to add a new property \"annotated\" with <code>NestedDecodable</code> wrapper and coding keys for it:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> address<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NameCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> id\n        <span class=\"token keyword\">case</span> address <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"user\"</span></span>\n        <span class=\"token keyword\">case</span> name <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"user\"</span></span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> details<span class=\"token punctuation\">,</span> address\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">NameCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> details<span class=\"token punctuation\">,</span> name\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This looks fine but unfortunately does not work as different enum cases can't have the same raw values... So to be able to decode nested values with the same root we need a different way to define their common root key. The only feasible way to do that is to define it separately in each nested keys enum:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">CodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> id\n<span class=\"token punctuation\">}</span>\n    \n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> user<span class=\"token punctuation\">,</span> details<span class=\"token punctuation\">,</span> address\n<span class=\"token punctuation\">}</span>\n    \n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">NameCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> user<span class=\"token punctuation\">,</span> details<span class=\"token punctuation\">,</span> name\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With that we again have a problem that <code>CodingKeys</code> does not define all the keys for all the properties in the <code>Contact</code> type. But now as we don't need to change their raw values we can leave it to compiler to generate these keys for us and remove <code>CodingKeys</code> type completely and only leave nested keys enums. But this means that we can't use compiler generated keys for <code>address</code> and <code>name</code> when decoding these properties, as their raw values won't be <code>\"user\"</code> any more. We need to use <code>user</code> keys from <code>AddressCodingKeys</code> and <code>NameCodingKeys</code> respectively. But we can't use these keys as they are not <code>Contact.CodingKeys</code>...</p>\n<p>Sounds like we are in a dead end. Notice though that all our keys are enums based on <code>String</code> raw values. So using the raw value <code>\"user\"</code> we can create either <code>CodingKeys.user</code> key, or <code>NameCodingKeys.user</code> or <code>AddressCodingKeys.user</code>. So what we need to restore our decoding code is to take the first key in <code>NestedKeys</code>, get its string value and use it to create a <code>Key</code> value. If the raw values of these enum cases match, then this convertion will work perfectly (and if does not - we throw):</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> rootKey <span class=\"token operator\">=</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">(</span>stringValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>first<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>stringValue<span class=\"token punctuation\">)</span></code></pre></div>\n<p>With that we can fix our decoding method:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">KeyedDecodingContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">decode</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">,</span> forKey key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>isEmpty <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">throw</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">let</span> wrappedValue <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token function\">containerForNestedKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>lastCase<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> wrappedValue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">containerForNestedKey</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">CaseIterable</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">KeyedDecodingContainer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> rootKey <span class=\"token operator\">=</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">(</span>stringValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>first<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>stringValue<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">throw</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">var</span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> rootKey<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>count <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">dropLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>forEach <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n                container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> container\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That's fine, it compiles now. But we still have one last issue - we still don't have a <code>CodingKeys.user</code> key. If we try to define it manually compiler will complain that there is no <code>Contact.user</code> property. If we don't do that then compiler won't generate this key for us, so our trick with converting keys from one type to another won't work at runtime. So we have nothing to do but to declare a <code>user</code> property to let compiler generate a <code>user</code> key for us:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> address<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NameCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> user<span class=\"token punctuation\">:</span> <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>But what should be its type? We don't actually want to decode anything into this property and we definetely don't want to specify it's full type which is <code>[String: [String: String]]</code>. We could do that but it will break whole decoding as soon as we start to have nested values of any other types - its type will become <code>[String: [String: Any]]</code> for which compiler won't be able to generate decoding code at all.</p>\n<p>So as we don't want to have any value in this <code>user</code> property can we declare it just as <code>Void</code>? We could but <code>Void</code> is not <code>Decodable</code> and we can't extend it to conform to any protocol. But what we can do is to define our own <code>Void</code>. In the end it's just a struct with no members.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Unit</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>from decoder<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decoder</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> address<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NameCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> user<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Unit</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>(We could name this type something like <code>RootKeyPlaceholder</code> to make its purpose more clear in this context, but <code>Unit</code> is a good general type that can be used for other purposes as well)</p>\n<p>And now we are really done. Complier will generate a <code>user</code> key for us, will automatically decode \"nothing\" into it and we then will be able to convert our key types and have multiple properties nested under the same root key.</p>\n<p>Let's recap and see the final version of the code:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> address<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    <span class=\"token attribute atrule\">@NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NameCodingKeys</span><span class=\"token operator\">></span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> user<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Unit</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">AddressCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> user<span class=\"token punctuation\">,</span> details<span class=\"token punctuation\">,</span> address\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">enum</span> <span class=\"token class-name\">NameCodingKeys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CodingKey</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> user<span class=\"token punctuation\">,</span> details<span class=\"token punctuation\">,</span> name\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Keys</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">CaseIterable</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>wrappedValue <span class=\"token operator\">=</span> wrappedValue\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">KeyedDecodingContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">decode</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">,</span> forKey key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>isEmpty <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">throw</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">let</span> wrappedValue <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token function\">containerForNestedKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NestedKeys</span><span class=\"token punctuation\">.</span>lastCase<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">NestedDecodable</span><span class=\"token punctuation\">(</span>wrappedValue<span class=\"token punctuation\">:</span> wrappedValue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">containerForNestedKey</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">CodingKey</span> <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">CaseIterable</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">KeyedDecodingContainer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> rootKey <span class=\"token operator\">=</span> <span class=\"token class-name\">Key</span><span class=\"token punctuation\">(</span>stringValue<span class=\"token punctuation\">:</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>first<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>stringValue<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">throw</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">var</span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> rootKey<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span>count <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span>allCases<span class=\"token punctuation\">.</span><span class=\"token function\">dropFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">dropLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>forEach <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n                container <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">nestedContainer</span><span class=\"token punctuation\">(</span>keyedBy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> container\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">CaseIterable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> lastCase<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Self</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> allCases<span class=\"token punctuation\">.</span>isEmpty <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> lastIndex <span class=\"token operator\">=</span> allCases<span class=\"token punctuation\">.</span><span class=\"token function\">index</span><span class=\"token punctuation\">(</span>allCases<span class=\"token punctuation\">.</span>endIndex<span class=\"token punctuation\">,</span> offsetBy<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> allCases<span class=\"token punctuation\">[</span>lastIndex<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">Unit</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decodable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>from decoder<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Decoder</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>Note that if we have just one nested property per root key we still can use the first version of the code. On the other hand we then will need to define all our keys manually just to provide few custom values, so if there are a lot of properties and just a few nested properties it might be easier to use the second approach. Then we will only need to add <code>Unit</code> properties for our root keys. Unfortunately it's not a completely safe solution as we can still make a typo in the name of this property and even in cases for nested keys and it will be possible to catch this only at runtime. But on the other hand Codable is inherently unsafe as we still can have a mismatch between JSON keys and properties names. So this seems like an acceptable nuance.</p>\n<p>As an excercise you can now try to implement <code>Encodable</code> and <code>Codable</code> for encoding nested values. Or you can go and see the full code that supports both encoding and decoding <a href=\"https://gist.github.com/ilyapuchka/52356678ca87b1303a161cecdcf1a240\">here</a>.</p>","fields":{"slug":"/decoding-nested-values-with-property-wrappers/"},"frontmatter":{"id":null,"title":"Decoding nested values with property wrappers","date":"February 13, 2020","description":"Property wrappers is one of the recent Swift proposals that have been welcomed probably the most by the community. Let's see how property wrappers can be used to solve one decoding edge case as an example - decoding deeply nested values.","tags":"Swift"}},"previous":{"excerpt":"Recently we were discussing in our team how to approach having fixes for bugs discovered during release both in release and the trunk branch to ensure we don'tâ€¦","fields":{"slug":"/git-rebase-vs-git-rebase-onto/"},"frontmatter":{"title":"git rebase vs. git rebase --onto","date":"November 10, 2019"}},"next":{"excerpt":"When you have a large code base more often than not you end up with your code broken down into multiple frameworks. But when it comes to resources often theyâ€¦","fields":{"slug":"/libraries-with-resources-optimized-for-build-time-and-application-size/"},"frontmatter":{"title":"Libraries with resources optimized for build time and application size","date":"June 27, 2023"}}},"pageContext":{"id":"c0cd6b60-c62f-58eb-89ca-8d6ecbc754bd","previousPostId":"dfe312ec-9c5e-5f86-8691-1b86834bafa5","nextPostId":"5bf8df2d-d79a-5428-8fbd-c946d78e2897"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}