{"componentChunkName":"component---src-templates-blog-post-js","path":"/extending-native-code-with-javascriptcore/","result":{"data":{"site":{"siteMetadata":{"title":"Ilya Puchka","siteUrl":"https://ilya.puchka.me"}},"markdownRemark":{"id":"e82bd09f-d3c1-5a91-9437-3a40bcf7795c","excerpt":"This week there were a lot of articles around the web about React Native and its place in a current iOS dev ecosystem. I was also playing with JavaScript latelyâ€¦","html":"<p>This week there were a lot of articles around the web about React Native and its place in a current iOS dev ecosystem. I was also playing with JavaScript lately, but in somewhat different context - JavaScriptCore. JavaScriptCore is a really great way to make your apps extensible by your users. There are some cool <a href=\"https://medium.com/ios-os-x-development/make-your-app-extensible-with-javascript-core-7074061f2b05#.uyvr8jela\">live examples</a> of awesome tools leveraging it.</p>\n<!-- description -->\n<p>As developers we are in a better position than our users as most of the time we can extend and patch our tools to our needs using native code. But our users can not. For example if you are building an app that uses some template engine, for example for Swift it can be <a href=\"https://github.com/kylef/Stencil\">Stencil</a>, users of your tool will most likely need to extend template language as it can be very limited. With JavaScriptCore you can give them that power.</p>\n<p>As every technology JavaScriptCore has its pros and cons. On one side it's fairly straightforward to implement, it's possible to completely separate implementation into a separate module and it provides a lot of possibilities to your users. On the other side it requires developers to write some boilerplate to support it (more you want to separate your native code from JavaScriptCore code more boilerplate you will need) and it's not designed for performance sensitive tasks (JavaScript code always runs synchronously, but you can have several contexts running in a separate threads, like CoreData contexts, just don't cross borders).</p>\n<p>There is a good documentation and there are bunch of articles talking describing basics of JavaScriptCore which are really very simple so I will not repeat them here. If you want you can see all the implementation details in <a href=\"https://github.com/ilyapuchka/StencilJS\">this repo</a>. Instead I'd like to provide some tips that I've discovered while digging into it.</p>\n<h4>Modularity</h4>\n<p>For interoperability with your native code JavaScriptCore requires conformance to a protocol that defines all methods and properties that you want to access from JavaScript. It must inherit <code>JSExport</code> protocol and must be marked with <code>@objc</code> which inherently means that only subclasses of <code>NSObject</code> can implement it. But you don't need to sacrifice your swifty design choices in favour of supporting JavaScriptCore. Using adapter classes is a straightforward solution which gives enough flexibility for the price of writing some boilerplate. You can even define them in a separate module (framework) keeping your core module free of any references to JavaScriptCore.</p>\n<h4>Exceptions</h4>\n<p>Catch all JavaScript exceptions and rethrow them as native errors. Basically that's the only way to debug JavaScript code. Rethrowing JavaScript exceptions as native errors will help you to integrate it with native code and provide users feedback in case something is wrong in their JavaScript code. It's very easy to do with a simple helper method:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">JSException</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CustomStringConvertible</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> exception<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JSValue</span>\n    <span class=\"token keyword\">var</span> description<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">exception</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> exception<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JSValue</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>exception <span class=\"token operator\">=</span> exception\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute atrule\">@discardableResult</span>\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">inJSContext</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> jsContext<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JSContext</span><span class=\"token punctuation\">,</span> <span class=\"token omit keyword\">_</span> block<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">JSValue</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">JSValue</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">block</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> exception <span class=\"token operator\">=</span> jsContext<span class=\"token punctuation\">.</span>exception <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token class-name\">JSException</span><span class=\"token punctuation\">(</span>exception<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> result\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">try</span> <span class=\"token function\">inJSContext</span><span class=\"token punctuation\">(</span>jsContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> jsContext<span class=\"token punctuation\">.</span><span class=\"token function\">evaluateScript</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can also get all of the console logs with this trick (<a href=\"https://medium.com/social-tables-tech/using-javascriptcore-in-a-production-ios-app-f09cfcd91fd6#.hwotyijv3\">source</a> in Objective-C):</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> consoleLog<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@convention</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> s <span class=\"token keyword\">in</span> <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">let</span> console <span class=\"token operator\">=</span> jscontext<span class=\"token punctuation\">.</span><span class=\"token function\">objectForKeyedSubscript</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"console\"</span></span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">setObject</span><span class=\"token punctuation\">(</span><span class=\"token function\">unsafeBitCast</span><span class=\"token punctuation\">(</span>consoleLog<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> forKeyedSubscript<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"log\"</span></span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">NSString</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4>Result</h4>\n<p>It's not possible (as far as I can tell) to use methods which <code>throws</code> even though they are bridged to Objective-C from Swift. Changing method to non-throwing and using <code>try!</code> could be one of your options, but there are other solutions - you can provide a function as a parameter and pass it an error (see the next tip), or you can use <code>Result</code>-like wrapper type (especially if you are already using <code>Result</code> in your native code).</p>\n<p>You can also use a simple decorator function that rethrows native error as JavaScript error:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">bridgingError</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> expression<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">T</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> <span class=\"token function\">expression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">JSContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">evaluateScript</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"throw \\\"</span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">error</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\\\"\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">wrapperMethodCalledFromJavaScript</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> bridgingError <span class=\"token punctuation\">{</span> <span class=\"token keyword\">try</span> wrapped<span class=\"token punctuation\">.</span><span class=\"token function\">nativeMethodThatThrows</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This way you can effectively rethrow native errors through JavaScript back to native code that invoked it or handle them in JavaScript code itself.</p>\n<h4>Closure parameters</h4>\n<p>You can not export methods with closure parameters. Instead of closure type use <code>JSValue</code> and <code>call(withArguments:)</code> when in native code you need to call a JavaScript function passed as a parameter. This way you can for example implement alternative API for handling errors (on JavaScript side you can pass <code>{}</code> if you don't need error handling)</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">wrapperMethodCalledFromJavaScript</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> onError<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JSValue</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> wrapped<span class=\"token punctuation\">.</span><span class=\"token function\">nativeMethodThatThrows</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n        onError<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>withArguments<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>error<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token nil constant\">nil</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">wrapperMethodCalledFromJavaScript</span><span class=\"token punctuation\">(</span><span class=\"token function\">function</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4>Constructors</h4>\n<p>To be able to construct your exported native types in JavaScript you can define a static factory method in a protocol. Swift initialisers are not automatically exported by JavaScriptCore. To use them you can do some trick - cast your initializer to <code>@convention(block)</code> closure and register it in a JavaScript context with a type name as a key:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">JSVariable</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">JSExportableVariable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> variable<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> newVariable<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@convention</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">JSVariable</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">JSVariable</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">init</span>\njsContext<span class=\"token punctuation\">.</span><span class=\"token function\">setObject</span><span class=\"token punctuation\">(</span><span class=\"token function\">unsafeBitCast</span><span class=\"token punctuation\">(</span>newVariable<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> forKeyedSubscript<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Variable\"</span></span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">NSString</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> variable <span class=\"token operator\">=</span> new <span class=\"token class-name\">Variable</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"name\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>With that you will not be able to access static methods of this type, but it may be still better than defining unneeded factory methods.</p>\n<h4>Key-Value coding</h4>\n<p>If you try to access property that is not present in the object you will get a nice <code>undefined</code> result of you script without any info what actually went wrong. In Cocoa in contrast to that we have Key-Value Coding which let us not only define <code>valueForKey</code> but also <code>valueForUndefinedKey</code>. Those methods are not available in JavaScript context (unless you define them in export protocol of course) and even if they would they will be not that convenient to use comparing with dot notation. There is a way to combine two approaches - using <a href=\"https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Proxy\">Proxy</a>. It let's you define i.e. getter or setter decorators which will be called every time you try to access any property on a proxy object. This is what we use in <a href=\"https://github.com/krzysztofzablocki/Sourcery/blob/master/Sourcery/Generating/Template/JavaScript/JavaScriptTemplate.swift#L46\">Sourcery</a> to catch some runtime errors in JavaScript templates.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> valueForKey<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@convention</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">Any</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> target<span class=\"token punctuation\">,</span> key <span class=\"token keyword\">in</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span>forKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\njsContext<span class=\"token punctuation\">.</span><span class=\"token function\">setObject</span><span class=\"token punctuation\">(</span>valueForKey<span class=\"token punctuation\">,</span> forKeyedSubscript<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"valueForKey\"</span></span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">NSString</span><span class=\"token punctuation\">)</span>\njsContext<span class=\"token punctuation\">.</span><span class=\"token function\">setObject</span><span class=\"token punctuation\">(</span>myObject<span class=\"token punctuation\">,</span> forKeyedSubscript<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"myObject\"</span></span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">NSString</span><span class=\"token punctuation\">)</span>\njsContext<span class=\"token punctuation\">.</span><span class=\"token function\">evaluateScript</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"myObject = new Proxy(myObject, { get: valueForKey })\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This way we replace original object with <code>Proxy</code> that wraps it and every time any property will be accessed on this proxy the <code>valueForKey</code> block will be called where we can redirect to <code>NSObject</code>'s <code>value(forKey:)</code> or do what ever else.</p>\n<h4>Playgrounds</h4>\n<p>In a playground define types that you want to export in a separate source file, not directly in a playground page. Only this way they will be exported.</p>\n<p>That's it for now. Are you using JavaScriptCore and have some more tips to share? Do that in the comments!</p>","fields":{"slug":"/extending-native-code-with-javascriptcore/"},"frontmatter":{"id":"5b6f5a3a9d28c70f0f015f81","title":"Extending native code with JavaScriptCore","date":"February 08, 2017","description":"This week there were a lot of articles around the web about React Native and its place in a current iOS dev ecosystem. I was also playing with JavaScript lately, but in somewhat different context - JavaScriptCore. JavaScriptCore is a really great way to make your apps extensible by your users. There are some cool live examples of awesome tools leveraging it.","tags":""}},"previous":{"excerpt":"As Roy Marmelstein said in his recent presentation at dotSwift - we love to be excited. Can not agree more. When we read a blog post that describes the conceptâ€¦","fields":{"slug":"/going-back-to-the-roots/"},"frontmatter":{"title":"Going back to the roots","date":"February 02, 2017"}},"next":{"excerpt":"With Xcode 8 Apple finally provided developers with first party API to develop plugin-like Xcode extensions, at the same time closing all the doors for inâ€¦","fields":{"slug":"/xcode-source-editor-extension-superpowered-with-sourcekitten/"},"frontmatter":{"title":"Xcode Source Editor Extension superpowered with SourceKitten","date":"February 19, 2017"}}},"pageContext":{"id":"e82bd09f-d3c1-5a91-9437-3a40bcf7795c","previousPostId":"70a868a5-f022-52f3-95eb-4794bd59e272","nextPostId":"2e9bac78-3f51-5094-a2a5-339d7444ea1e"}},"staticQueryHashes":["2355076697","2841359383"],"slicesMap":{}}